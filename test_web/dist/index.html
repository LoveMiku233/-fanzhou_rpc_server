<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>泛舟RPC服务器调试工具</title>
    <!-- ========================================================
         泛舟RPC服务器调试工具
         
         功能说明：
         1. 通过WebSocket连接到RPC服务器（需要websocket代理）
         2. 提供快捷操作按钮用于常用RPC方法
         3. 支持继电器控制和分组管理
         4. 提供设备列表和分组列表的可视化显示
         5. 左右布局：导航在左侧，内容在右侧
         6. 动态背景动画效果
         
         使用方法：
         1. 在设备上启动websocat代理：
            websocat --text ws-l:0.0.0.0:12346 tcp:127.0.0.1:12345
         2. 在浏览器中打开此页面
         3. 输入设备IP地址和WebSocket端口，点击连接
         
         RPC说明：
         - relay.control: 控制单个节点的单个通道
         - group.control: 控制分组中所有节点的指定通道
         ======================================================== -->
    <!-- 引入外部样式表 -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/blueprint.css">
</head>
<body>
    <!-- ==================== 页面头部（紧凑版） ==================== -->
    <div class="header">
        <h1>🚀 泛舟RPC调试工具</h1>
        <div class="header-status">
            <span class="status-badge disconnected" id="headerConnectionStatus">
                <span class="status-dot"></span>
                <span>未连接</span>
            </span>
        </div>
    </div>

    <!-- ==================== 主布局容器 ==================== -->
    <div class="main-layout">
        <!-- ==================== 左侧导航栏 ==================== -->
        <div class="sidebar">
            <div class="sidebar-nav">
                <button class="nav-btn active" onclick="showPage('quick')" data-page="quick">
                    🏠 主页
                </button>
                <button class="nav-btn" onclick="showPage('devices')" data-page="devices">
                    🔌 设备
                </button>
                <button class="nav-btn" onclick="showPage('groups')" data-page="groups">
                    📂 分组
                </button>
                <button class="nav-btn" onclick="showPage('strategy')" data-page="strategy">
                    ⚡ 策略
                </button>
                <button class="nav-btn" onclick="showPage('sensors')" data-page="sensors">
                    📡 传感器
                </button>
                <button class="nav-btn" onclick="showPage('mqtt')" data-page="mqtt">
                    ☁️ MQTT
                </button>
                <button class="nav-btn" onclick="showPage('monitor')" data-page="monitor">
                    📊 监控
                </button>
                <button class="nav-btn" onclick="showPage('settings')" data-page="settings">
                    ⚙️ 设置
                </button>
            </div>
        </div>

        <!-- ==================== 右侧内容区 ==================== -->
        <div class="content-area">
            <div class="card">

            <!-- ==================== 连接设置页面 ==================== -->
            <div class="page-content" id="page-connection">
                <h3 style="margin-bottom: 16px; color: #333;">📡 连接设置</h3>
                
                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                    <div class="form-row">
                        <!-- RPC服务器地址输入 -->
                        <div class="form-group">
                            <label>RPC服务器地址 <span style="color: #999; font-size: 11px;">（目标设备的IP）</span></label>
                            <input type="text" id="serverHost" placeholder="例如: 192.168.1.100" value="">
                        </div>
                        <!-- RPC服务器TCP端口 -->
                        <div class="form-group">
                            <label>RPC端口 <span style="color: #999; font-size: 11px;">（TCP端口，默认12345）</span></label>
                            <input type="number" id="rpcPort" placeholder="RPC端口" value="12345">
                        </div>
                        <!-- 本地WebSocket端口输入 -->
                        <div class="form-group">
                            <label>WS端口 <span style="color: #999; font-size: 11px;">（本地代理端口）</span></label>
                            <input type="number" id="serverPort" placeholder="WS端口" value="12346">
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                        <!-- Tauri环境下显示代理控制按钮 -->
                        <button id="websocatToggleBtn" onclick="toggleWebsocatProxy()" class="success" style="min-width: 150px; display: none;">🚀 启动代理</button>
                        <!-- 连接/断开按钮 -->
                        <button id="connectBtn" onclick="toggleConnection()" style="min-width: 150px;">🔌 连接</button>
                        <!-- 连接状态显示 -->
                        <span class="status-badge disconnected" id="connectionStatus">
                            <span class="status-dot"></span>
                            <span>未连接</span>
                        </span>
                    </div>
                </div>
                
                <!-- Tauri桌面应用提示 -->
                <div id="tauriHint" style="display: none; background: #e8f5e9; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                    <strong style="color: #2e7d32;">🖥️ Tauri桌面应用模式</strong>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;">
                        检测到Tauri环境！操作步骤：<br>
                        1. 填写目标设备的RPC服务器地址（如 192.168.0.104）和RPC端口（默认12345）<br>
                        2. 点击"启动代理"按钮启动本地websocat代理（本机 → 目标设备）<br>
                        3. 点击"连接"按钮通过WebSocket连接到本地代理
                    </p>
                </div>
                
                <!-- 连接原理说明 -->
                <div style="background: #fff3e0; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                    <strong style="color: #e65100;">📖 连接原理说明</strong>
                    <p style="color: #666; font-size: 13px; margin-top: 8px; line-height: 1.6;">
                        <strong>问题：</strong>浏览器无法直接连接TCP，只能使用WebSocket协议。<br>
                        <strong>解决方案：</strong>使用websocat作为中间代理进行协议转换。<br><br>
                        <strong>数据流向：</strong><br>
                        <code style="background: #ffe0b2; padding: 2px 6px; border-radius: 4px;">
                            浏览器 → WebSocket(本机:12346) → websocat代理 → TCP(目标设备:12345)
                        </code><br><br>
                        <strong>注意：</strong>websocat代理需要在<em>本机</em>运行，用于连接到<em>远程</em>RPC服务器。
                    </p>
                </div>
                
                <!-- 连接说明 -->
                <div class="help-section" id="manualProxyHelp">
                    <h4>📋 手动启动代理（非Tauri环境）</h4>
                    <p style="margin-bottom: 10px; color: #666;">如果不是使用Tauri桌面应用，需要在<strong>本机</strong>运行以下命令启动代理：</p>
                    <pre>
# 安装websocat（如果尚未安装）
# 下载地址: https://github.com/vi/websocat/releases

# 在本机启动WebSocket到TCP的代理（连接到远程RPC服务器）
# 将 192.168.0.104 替换为目标设备的实际IP地址
websocat --text ws-l:0.0.0.0:12346 tcp:192.168.0.104:12345

# 然后在浏览器中连接到本地WebSocket代理
# 服务器地址填写: localhost 或 127.0.0.1
# WS端口填写: 12346</pre>
                </div>
                
                <!-- 快速提示 -->
                <div style="background: #e3f2fd; padding: 15px 20px; border-radius: 12px; margin-top: 20px; border-left: 4px solid #2196f3;">
                    <strong style="color: #1565c0;">💡 提示</strong>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;">
                        连接成功后，请切换到"主页"标签页开始使用各项功能。<br>
                        如果遇到连接问题，请检查：1) 目标设备是否在线 2) RPC服务是否运行 3) 防火墙设置
                    </p>
                </div>
            </div>

            <!-- ==================== 快捷操作页面 ==================== -->
            <div class="page-content active" id="page-quick">
                <!-- 连接状态栏 - 紧凑设计 -->
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 10px; flex-wrap: wrap;">
                    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 140px;">
                        <input type="text" id="serverHost" placeholder="设备IP地址" value="" style="padding: 8px 10px; font-size: 13px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0; width: 80px;">
                        <input type="number" id="rpcPort" placeholder="RPC" value="12345" style="padding: 8px 10px; font-size: 13px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0; width: 80px;">
                        <input type="number" id="serverPort" placeholder="WS" value="12346" style="padding: 8px 10px; font-size: 13px;">
                    </div>
                    <button id="websocatToggleBtn" onclick="toggleWebsocatProxy()" class="success" style="display: none; padding: 8px 12px;">🚀 代理</button>
                    <button id="connectBtn" onclick="toggleConnection()" style="padding: 8px 14px;">🔌 连接</button>
                    <span class="status-badge disconnected" id="connectionStatus">
                        <span class="status-dot"></span>
                        <span>未连接</span>
                    </span>
                </div>
                
                <!-- 急停按钮 - 紧凑版 -->
                <div style="margin-bottom: 16px;">
                    <button id="emergencyStopBtn" onclick="emergencyStop()" style="
                        width: 100%;
                        padding: 14px;
                        font-size: 18px;
                        font-weight: bold;
                        color: white;
                        background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
                        border: 2px solid #922b21;
                        border-radius: 10px;
                        cursor: pointer;
                        box-shadow: 0 3px 12px rgba(231, 76, 60, 0.35);
                        transition: all 0.2s ease;
                    " onmouseover="this.style.transform='scale(1.01)'; this.style.boxShadow='0 4px 15px rgba(231, 76, 60, 0.5)';"
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 3px 12px rgba(231, 76, 60, 0.35)';">
                        🛑 急停
                    </button>
                </div>

                <!-- 快速导航卡片 - 更紧凑 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 16px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 14px; border-radius: 10px; color: white; cursor: pointer; transition: transform 0.2s;" onclick="showPage('devices'); refreshDeviceList()" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-size: 20px; margin-bottom: 4px;">🔌</div>
                        <div style="font-size: 12px; font-weight: 600;">设备管理</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); padding: 14px; border-radius: 10px; color: white; cursor: pointer; transition: transform 0.2s;" onclick="showPage('groups'); refreshGroupList()" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-size: 20px; margin-bottom: 4px;">📂</div>
                        <div style="font-size: 12px; font-weight: 600;">分组控制</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); padding: 14px; border-radius: 10px; color: white; cursor: pointer; transition: transform 0.2s;" onclick="showPage('strategy'); refreshStrategyList()" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-size: 20px; margin-bottom: 4px;">⚡</div>
                        <div style="font-size: 12px; font-weight: 600;">自动策略</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 14px; border-radius: 10px; color: white; cursor: pointer; transition: transform 0.2s;" onclick="showPage('sensors'); refreshSensorMapping()" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-size: 20px; margin-bottom: 4px;">📡</div>
                        <div style="font-size: 12px; font-weight: 600;">传感器</div>
                    </div>
                </div>

                <!-- 快捷操作按钮 -->
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                    <span style="font-size: 13px; font-weight: 600; color: #333;">快捷操作</span>
                    <button class="success" onclick="saveConfig()" style="padding: 6px 12px; font-size: 12px;">💾 保存</button>
                </div>
                <div class="quick-actions-grid">
                    <button class="quick-action-btn" onclick="callMethod('rpc.ping', {})">
                        <span class="icon">🔔</span>
                        Ping
                    </button>
                    <button class="quick-action-btn" onclick="callMethod('sys.info', {})">
                        <span class="icon">ℹ️</span>
                        系统
                    </button>
                    <button class="quick-action-btn warning" onclick="checkCanStatus()">
                        <span class="icon">🔧</span>
                        CAN
                    </button>
                    <button class="quick-action-btn success" onclick="callMethod('relay.queryAll', {})">
                        <span class="icon">🔍</span>
                        查询
                    </button>
                </div>
            </div>

            <!-- ==================== 设备列表页面 ==================== -->
            <!-- 
                设备列表页面说明：
                - 显示所有已配置的CAN继电器设备
                - 每个设备以卡片形式展示，包含状态和控制按钮
                - 支持单通道控制和全部通道控制
                - 设备在线状态由服务端根据最后响应时间判断（30秒内有响应认为在线）
            -->
            <div class="page-content" id="page-devices">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">🔌 设备列表</h3>
                    <div class="btn-group">
                        <button onclick="refreshDeviceList()">🔄 刷新列表</button>
                        <button class="secondary" onclick="readDeviceConfig()">📋 读取配置</button>
                        <button class="warning" onclick="checkCanStatus()">🔧 CAN诊断</button>
                    </div>
                </div>
                
                <!-- CAN状态警告提示（当CAN未打开时显示） -->
                <div id="canWarningPanel" style="display: none; background: #fff3e0; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                    <h4 style="margin-bottom: 10px; color: #e65100;">⚠️ CAN总线未打开</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                        控制命令无法发送！CAN总线未正确连接或配置。
                    </p>
                    <div class="btn-group">
                        <button class="warning" onclick="checkCanStatus()">🔧 查看诊断信息</button>
                    </div>
                </div>
                
                <!-- 设备配置显示区域 -->
                <div id="deviceConfigPanel" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">📋 设备配置信息</h4>
                    <pre id="deviceConfigContent" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 13px;"></pre>
                </div>
                
                <!-- 设备卡片网格视图 - 整合了列表和卡片功能 -->
                <!-- 每个卡片既显示设备状态，也提供控制按钮 -->
                <div id="deviceListEmpty" class="data-list-empty" style="display: none; background: #f8f9fa; border-radius: 12px; padding: 40px 20px;">
                    <p>📭 暂无设备数据</p>
                    <p style="font-size: 12px; margin-top: 10px;">请先连接服务器并点击"刷新列表"</p>
                </div>
                <div class="device-cards" id="deviceCards">
                    <!-- 设备卡片将由JavaScript动态生成 -->
                </div>
            </div>

            <!-- ==================== 分组管理页面 ==================== -->
            <div class="page-content" id="page-groups">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">📂 分组管理</h3>
                    <div class="btn-group">
                        <button onclick="refreshGroupList()">🔄 刷新</button>
                    </div>
                </div>
                
                <!-- 操作按钮区 - 表格上方 -->
                <div class="action-toolbar" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px;">
                    <button class="success" onclick="openCreateGroupModal()" style="min-width: 120px;">
                        ➕ 创建分组
                    </button>
                    <button class="secondary" onclick="openManageChannelModal()" style="min-width: 120px;">
                        🔧 通道管理
                    </button>
                    <button class="warning" onclick="batchControlGroups('stop')">
                        ⏹️ 停止
                    </button>
                    <button class="success" onclick="batchControlGroups('fwd')">
                        ▶️ 正转
                    </button>
                    <button onclick="batchControlGroups('rev')">
                        ◀️ 反转
                    </button>
                </div>

                <!-- 分组卡片视图 -->
                <div id="groupCardsEmpty" class="data-list-empty" style="display: none; background: #f8f9fa; border-radius: 10px; padding: 30px 16px;">
                    <p>📭 暂无分组</p>
                    <p style="font-size: 11px; margin-top: 6px;">点击"刷新"获取数据</p>
                </div>
                <div class="group-cards" id="groupCards">
                    <!-- 分组卡片将由JavaScript动态生成 -->
                </div>
            </div>

            <!-- ==================== 策略管理页面（泛舟云协议） ==================== -->
            <div class="page-content" id="page-strategy">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
                    <h3 style="color: #333; font-size: 1.2em;">⚡ 场景/策略管理</h3>
                    <div class="btn-group">
                        <button onclick="refreshSceneList()">🔄 刷新</button>
                        <button onclick="syncSceneFromCloud()">☁️ 同步</button>
                        <button onclick="openSceneEditorModal()" class="success">➕ 新建场景</button>
                    </div>
                </div>

                <!-- 系统架构说明 -->
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <strong style="color: #1565c0;">💡 泛舟云IoT场景管理</strong>
                    <p style="color: #666; font-size: 13px; margin-top: 8px;">
                        基于云-边-端三层架构，支持自动场景(auto)和手动场景(manual)。场景通过MQTT协议与云端同步，支持离线自治模式。
                    </p>
                </div>

                <!-- 传感器设备卡片 -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <span style="font-size: 14px; font-weight: 600; color: #333;">📡 设备数据源</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
                        <!-- 环境传感器卡片 -->
                        <div class="sensor-device-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 14px; color: white;">
                            <div style="font-size: 24px; margin-bottom: 6px;">🌡️</div>
                            <div style="font-weight: 600; font-size: 13px;">环境传感器</div>
                            <div style="font-size: 11px; opacity: 0.85; margin-top: 4px;">温湿度/光照/CO₂</div>
                            <div id="envSensorStatus" style="font-size: 10px; margin-top: 6px; padding: 3px 8px; background: rgba(255,255,255,0.2); border-radius: 8px; display: inline-block;">--</div>
                        </div>
                        <!-- 土壤传感器卡片 -->
                        <div class="sensor-device-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 12px; padding: 14px; color: white;">
                            <div style="font-size: 24px; margin-bottom: 6px;">🌱</div>
                            <div style="font-weight: 600; font-size: 13px;">土壤传感器</div>
                            <div style="font-size: 11px; opacity: 0.85; margin-top: 4px;">温湿度/氮磷钾</div>
                            <div id="soilSensorStatus" style="font-size: 10px; margin-top: 6px; padding: 3px 8px; background: rgba(255,255,255,0.2); border-radius: 8px; display: inline-block;">--</div>
                        </div>
                        <!-- 水质传感器卡片 -->
                        <div class="sensor-device-card" style="background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%); border-radius: 12px; padding: 14px; color: white;">
                            <div style="font-size: 24px; margin-bottom: 6px;">💧</div>
                            <div style="font-weight: 600; font-size: 13px;">水质传感器</div>
                            <div style="font-size: 11px; opacity: 0.85; margin-top: 4px;">溶解氧/PH值</div>
                            <div id="waterSensorStatus" style="font-size: 10px; margin-top: 6px; padding: 3px 8px; background: rgba(255,255,255,0.2); border-radius: 8px; display: inline-block;">--</div>
                        </div>
                        <!-- 气象站卡片 -->
                        <div class="sensor-device-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; padding: 14px; color: white;">
                            <div style="font-size: 24px; margin-bottom: 6px;">🌤️</div>
                            <div style="font-weight: 600; font-size: 13px;">气象站</div>
                            <div style="font-size: 11px; opacity: 0.85; margin-top: 4px;">风速/风向/气压</div>
                            <div id="weatherStationStatus" style="font-size: 10px; margin-top: 6px; padding: 3px 8px; background: rgba(255,255,255,0.2); border-radius: 8px; display: inline-block;">--</div>
                        </div>
                        <!-- 执行机构卡片 -->
                        <div class="sensor-device-card" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); border-radius: 12px; padding: 14px; color: white;">
                            <div style="font-size: 24px; margin-bottom: 6px;">⚙️</div>
                            <div style="font-weight: 600; font-size: 13px;">执行机构</div>
                            <div style="font-size: 11px; opacity: 0.85; margin-top: 4px;">继电器/风机/水泵</div>
                            <div id="actuatorStatus" style="font-size: 10px; margin-top: 6px; padding: 3px 8px; background: rgba(255,255,255,0.2); border-radius: 8px; display: inline-block;">--</div>
                        </div>
                    </div>
                </div>

                <!-- 快速场景模板 -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <span style="font-size: 14px; font-weight: 600; color: #333;">⚡ 快速创建模板</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px;">
                        <div onclick="createQuickScene('hightemp_vent')" class="quick-template-card" style="background: #fff; border: 2px solid #eb3349; border-radius: 10px; padding: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)';this.style.background='#fef1f2'" onmouseout="this.style.transform='scale(1)';this.style.background='#fff'">
                            <div style="font-size: 22px; margin-bottom: 4px;">🌡️🌬️</div>
                            <div style="font-weight: 600; font-size: 12px; color: #eb3349;">高温通风</div>
                            <div style="font-size: 10px; color: #888; margin-top: 2px;">温度&gt;30°C启动风机</div>
                        </div>
                        <div onclick="createQuickScene('lowtemp_heat')" class="quick-template-card" style="background: #fff; border: 2px solid #00b4db; border-radius: 10px; padding: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)';this.style.background='#e6f7fb'" onmouseout="this.style.transform='scale(1)';this.style.background='#fff'">
                            <div style="font-size: 22px; margin-bottom: 4px;">❄️🔥</div>
                            <div style="font-weight: 600; font-size: 12px; color: #00b4db;">低温保暖</div>
                            <div style="font-size: 10px; color: #888; margin-top: 2px;">温度&lt;10°C启动加热</div>
                        </div>
                        <div onclick="createQuickScene('dry_irrigation')" class="quick-template-card" style="background: #fff; border: 2px solid #11998e; border-radius: 10px; padding: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)';this.style.background='#e6f7f5'" onmouseout="this.style.transform='scale(1)';this.style.background='#fff'">
                            <div style="font-size: 22px; margin-bottom: 4px;">🌱💧</div>
                            <div style="font-weight: 600; font-size: 12px; color: #11998e;">干旱灌溉</div>
                            <div style="font-size: 10px; color: #888; margin-top: 2px;">土壤湿度&lt;30%浇水</div>
                        </div>
                        <div onclick="createQuickScene('light_shade')" class="quick-template-card" style="background: #fff; border: 2px solid #f093fb; border-radius: 10px; padding: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)';this.style.background='#fdf2fc'" onmouseout="this.style.transform='scale(1)';this.style.background='#fff'">
                            <div style="font-size: 22px; margin-bottom: 4px;">☀️🌂</div>
                            <div style="font-weight: 600; font-size: 12px; color: #f093fb;">强光遮阳</div>
                            <div style="font-size: 10px; color: #888; margin-top: 2px;">光照&gt;50000lx遮阳</div>
                        </div>
                    </div>
                </div>

                <!-- 自动场景列表 -->
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 14px; font-weight: 600; color: #333;">🤖 自动场景 (Auto)</span>
                        <span id="autoSceneCount" style="font-size: 11px; background: #667eea; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
                    </div>
                    <div id="autoSceneCardsEmpty" class="data-list-empty" style="display: none; background: #f8f9fa; border-radius: 10px; padding: 30px 16px; text-align: center;">
                        <p style="font-size: 14px; color: #666;">📭 暂无自动场景</p>
                        <p style="font-size: 12px; margin-top: 6px; color: #999;">自动场景会根据传感器条件自动触发执行</p>
                    </div>
                    <div class="scene-cards-grid" id="autoSceneCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px;">
                        <!-- 自动场景卡片将由JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 手动场景列表 -->
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 14px; font-weight: 600; color: #333;">👆 手动场景 (Manual)</span>
                        <span id="manualSceneCount" style="font-size: 11px; background: #e67e22; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
                    </div>
                    <div id="manualSceneCardsEmpty" class="data-list-empty" style="display: none; background: #f8f9fa; border-radius: 10px; padding: 30px 16px; text-align: center;">
                        <p style="font-size: 14px; color: #666;">📭 暂无手动场景</p>
                        <p style="font-size: 12px; margin-top: 6px; color: #999;">手动场景需要用户手动触发执行</p>
                    </div>
                    <div class="scene-cards-grid" id="manualSceneCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px;">
                        <!-- 手动场景卡片将由JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 定时器列表 -->
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 14px; font-weight: 600; color: #333;">⏰ 定时器 (Timer)</span>
                        <span id="timerCount" style="font-size: 11px; background: #9c27b0; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
                        <button onclick="openTimerEditorModal()" class="secondary" style="padding: 4px 10px; font-size: 11px; margin-left: auto;">+ 添加定时</button>
                    </div>
                    <div id="timerCardsEmpty" class="data-list-empty" style="display: none; background: #f8f9fa; border-radius: 10px; padding: 30px 16px; text-align: center;">
                        <p style="font-size: 14px; color: #666;">📭 暂无定时器</p>
                        <p style="font-size: 12px; margin-top: 6px; color: #999;">定时器会在指定时间自动执行</p>
                    </div>
                    <div class="scene-cards-grid" id="timerCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px;">
                        <!-- 定时器卡片将由JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 调试工具 -->
                <details style="margin-top: 16px; background: #fce4ec; padding: 14px; border-radius: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #7b1fa2; font-size: 13px;">🔧 开发者调试工具</summary>
                    <div style="margin-top: 12px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>设备编码</label>
                                <input type="text" id="debugDeviceCode" value="864708069172099" placeholder="设备编码">
                            </div>
                            <div class="form-group">
                                <label>属性标识</label>
                                <input type="text" id="debugIdentifier" value="airTemp" placeholder="如: airTemp, soilHum">
                            </div>
                            <div class="form-group">
                                <label>数值</label>
                                <input type="number" id="debugIdentifierValue" value="25" step="0.1">
                            </div>
                        </div>
                        <div class="btn-group" style="margin-top: 10px;">
                            <button class="success" onclick="setDebugSensorValue()" style="padding: 8px 14px; font-size: 12px;">📤 模拟上报</button>
                            <button onclick="setDebugSensorQuick(35)" style="background: #f44336; color: white; padding: 8px 10px; font-size: 12px;">🌡️ 35°C</button>
                            <button onclick="setDebugSensorQuick(5)" style="background: #2196f3; color: white; padding: 8px 10px; font-size: 12px;">❄️ 5°C</button>
                            <button onclick="testSceneTrigger()" style="background: #9c27b0; color: white; padding: 8px 10px; font-size: 12px;">⚡ 测试触发</button>
                        </div>
                    </div>
                </details>
            </div>

            <!-- ==================== 高级功能页面（合并继电器控制、自定义调用、帮助） ==================== -->
            <div class="page-content" id="page-custom">
                <h3 style="margin-bottom: 20px; color: #333;">🛠️ 高级功能</h3>
                
                <!-- 继电器直接控制 -->
                <details open style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">🎛️ 继电器直接控制</summary>
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>节点ID</label>
                            <input type="number" id="relayNode" value="1" min="1" max="255">
                        </div>
                        <div class="form-group">
                            <label>通道</label>
                            <select id="relayChannel">
                                <option value="0">CH0</option>
                                <option value="1">CH1</option>
                                <option value="2">CH2</option>
                                <option value="3">CH3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>动作</label>
                            <select id="relayAction">
                                <option value="stop">⏹️ 停止</option>
                                <option value="fwd">▶️ 正转</option>
                                <option value="rev">◀️ 反转</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="success" onclick="controlRelay()">⚡ 执行</button>
                        <button onclick="queryRelay()">🔍 查询</button>
                        <button onclick="queryRelayAll()">📊 全部</button>
                    </div>
                    
                    <!-- 分组控制 -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <strong style="display: block; margin-bottom: 10px;">📦 分组控制</strong>
                        <div class="form-row">
                            <div class="form-group">
                                <label>分组ID</label>
                                <input type="number" id="groupControlId" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label>通道</label>
                                <select id="groupControlChannel">
                                    <option value="-1">📡 绑定通道</option>
                                    <option value="0">CH0</option>
                                    <option value="1">CH1</option>
                                    <option value="2">CH2</option>
                                    <option value="3">CH3</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>动作</label>
                                <select id="groupControlAction">
                                    <option value="stop">⏹️ 停止</option>
                                    <option value="fwd">▶️ 正转</option>
                                    <option value="rev">◀️ 反转</option>
                                </select>
                            </div>
                        </div>
                        <button class="success" onclick="controlGroup()">⚡ 执行分组控制</button>
                    </div>
                </details>

                <!-- 自定义RPC调用 -->
                <details style="background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">🛠️ 自定义RPC调用</summary>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>方法名</label>
                        <input type="text" id="methodName" placeholder="例如: rpc.ping, relay.control">
                    </div>
                    <div class="form-group">
                        <label>参数 (JSON格式)</label>
                        <textarea id="methodParams" placeholder='例如: {"node": 1, "ch": 0, "action": "fwd"}'>{}</textarea>
                    </div>
                    <button onclick="callCustomMethod()">🚀 发送请求</button>
                </details>

                <!-- 配置管理 -->
                <details style="background: #fff3e0; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">💾 配置管理</summary>
                    <p style="color: #666; font-size: 13px; margin: 15px 0;">
                        通过Web页面创建的修改默认只保存在内存中，重启后会丢失。
                    </p>
                    <div class="btn-group">
                        <button class="success" onclick="saveConfig()">💾 保存配置</button>
                        <button onclick="getConfig()">📋 查看配置</button>
                        <button class="warning" onclick="reloadConfig()">🔄 重载配置</button>
                    </div>
                </details>

                <!-- 常用RPC方法参考 -->
                <details style="background: #f5f5f5; padding: 20px; border-radius: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">📚 常用RPC方法参考</summary>
                    <ul style="margin-top: 15px; color: #666; font-size: 13px; line-height: 1.8;">
                        <li><code>rpc.ping</code> - 测试连接</li>
                        <li><code>sys.info</code> - 系统信息</li>
                        <li><code>can.status</code> - CAN总线状态</li>
                        <li><code>relay.control</code> - 控制继电器 <code>{"node": 1, "ch": 0, "action": "fwd"}</code></li>
                        <li><code>relay.statusAll</code> - 查询设备状态 <code>{"node": 1}</code></li>
                        <li><code>group.list</code> - 分组列表</li>
                        <li><code>group.control</code> - 分组控制 <code>{"groupId": 1, "ch": 0, "action": "stop"}</code></li>
                        <li><code>auto.strategy.list</code> - 策略列表</li>
                        <li><code>config.save</code> - 保存配置</li>
                    </ul>
                </details>
            </div>

            <!-- ==================== MQTT配置页面 ==================== -->
            <div class="page-content" id="page-mqtt">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">☁️ MQTT多通道管理</h3>
                    <div class="btn-group">
                        <button onclick="refreshMqttChannels()">🔄 刷新</button>
                        <button class="success" onclick="openAddMqttChannelModal()">➕ 添加通道</button>
                    </div>
                </div>

                <!-- 说明信息 -->
                <div style="background: #e3f2fd; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <strong style="color: #1565c0;">💡 MQTT多通道功能</strong>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;">
                        支持同时连接多个MQTT Broker，每个通道可配置不同的地址、认证和主题前缀。当设备状态变化时，自动向所有已连接通道推送消息。
                    </p>
                </div>

                <!-- MQTT通道列表 -->
                <div id="mqttChannelsEmpty" class="data-list-empty" style="display: none; background: #f8f9fa; border-radius: 12px; padding: 40px 20px;">
                    <p>📭 暂无MQTT通道</p>
                    <p style="font-size: 12px; margin-top: 10px;">点击"➕ 添加通道"创建新的MQTT连接</p>
                </div>
                <div class="mqtt-channels" id="mqttChannelsContainer">
                    <!-- 通道卡片将由JavaScript动态生成 -->
                </div>

                <!-- MQTT调试面板 -->
                <div style="margin-top: 25px;">
                    <h4 style="color: #333; margin-bottom: 15px;">🔧 MQTT调试</h4>
                    
                    <!-- 发布消息 -->
                    <details open style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #333;">📤 发布消息</summary>
                        <div class="form-row" style="margin-top: 15px;">
                            <div class="form-group">
                                <label>通道ID</label>
                                <input type="number" id="mqttDebugChannelId" value="1" min="1">
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label>主题</label>
                                <input type="text" id="mqttDebugTopic" placeholder="例如: test/topic">
                            </div>
                            <div class="form-group">
                                <label>QoS</label>
                                <select id="mqttDebugQos">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>消息内容</label>
                            <textarea id="mqttDebugPayload" placeholder='{"message": "Hello MQTT"}'>{}</textarea>
                        </div>
                        <button class="success" onclick="mqttPublish()">📤 发布消息</button>
                    </details>
                    
                    <!-- 订阅管理 -->
                    <details open style="background: #fff3e0; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #333;">📥 订阅管理</summary>
                        <div style="background: #fff8e1; padding: 12px 15px; border-radius: 8px; margin: 15px 0; font-size: 13px; color: #f57c00;">
                            💡 <strong>提示：</strong>添加订阅后，收到的消息将显示在下方消息列表中，并触发回调函数。
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>通道ID</label>
                                <input type="number" id="mqttSubChannelId" value="1" min="1">
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label>订阅主题</label>
                                <input type="text" id="mqttSubTopic" placeholder="例如: sensor/+/data 或 device/#">
                            </div>
                            <div class="form-group">
                                <label>QoS</label>
                                <select id="mqttSubQos">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                </select>
                            </div>
                        </div>
                        <div class="btn-group" style="margin-bottom: 15px;">
                            <button class="success" onclick="mqttSubscribe()">➕ 添加订阅</button>
                            <button class="danger" onclick="mqttUnsubscribe()">➖ 取消订阅</button>
                            <button onclick="mqttListSubscriptions()">📋 查看订阅列表</button>
                        </div>
                        
                        <!-- 订阅列表 -->
                        <div id="mqttSubscriptionsList" style="display: none; background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">当前订阅列表：</div>
                            <div id="mqttSubscriptionsContent" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                        </div>
                    </details>
                    
                    <!-- 接收到的消息 -->
                    <details open style="background: #e8f5e9; padding: 20px; border-radius: 12px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #333;">📬 接收到的消息</summary>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0 10px 0;">
                            <span style="font-size: 13px; color: #666;">消息将在触发订阅时自动显示</span>
                            <button class="secondary" onclick="clearMqttMessages()" style="padding: 6px 12px; font-size: 12px;">🗑️ 清空</button>
                        </div>
                        <div id="mqttMessagesContainer" style="background: #1e1e1e; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: 'Fira Code', 'Consolas', monospace; font-size: 13px;">
                            <div style="color: #666; text-align: center; padding: 20px;">等待消息...</div>
                        </div>
                    </details>
                </div>
            </div>

            <!-- ==================== Token管理页面 ==================== -->
            <div class="page-content" id="page-tokens">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">🔑 Token管理</h3>
                    <div class="btn-group">
                        <button onclick="refreshTokenList()">🔄 刷新</button>
                        <button class="success" onclick="openCreateTokenModal()">➕ 创建Token</button>
                    </div>
                </div>

                <!-- 说明信息 -->
                <div style="background: #e3f2fd; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <strong style="color: #1565c0;">💡 Token认证</strong>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;">
                        Token用于API认证和设备授权。每个Token可以设置不同的权限级别和过期时间。使用Token可以避免频繁输入密码，同时提供更细粒度的访问控制。
                    </p>
                </div>

                <!-- 认证状态 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">🔐 认证状态</h4>
                    <div id="authStatusPanel">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="font-size: 12px; color: #666;">认证功能</div>
                                <div style="font-size: 18px; font-weight: bold; color: #333; margin-top: 5px;" id="authEnabledStatus">--</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="font-size: 12px; color: #666;">当前Token</div>
                                <div style="font-size: 14px; font-weight: bold; color: #333; margin-top: 5px;" id="currentTokenStatus">--</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="font-size: 12px; color: #666;">Token有效期</div>
                                <div style="font-size: 18px; font-weight: bold; color: #333; margin-top: 5px;" id="tokenExpireStatus">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Token列表 -->
                <h4 style="margin-bottom: 15px; color: #333;">📋 已授权Token列表</h4>
                <div id="tokenListEmpty" class="data-list-empty" style="display: none; background: #f8f9fa; border-radius: 12px; padding: 40px 20px;">
                    <p>📭 暂无Token</p>
                    <p style="font-size: 12px; margin-top: 10px;">点击"➕ 创建Token"添加新的访问令牌</p>
                </div>
                <div id="tokenListContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px;">
                    <!-- Token卡片将由JavaScript动态生成 -->
                </div>

                <!-- 登录功能 -->
                <details style="background: #fff3e0; padding: 20px; border-radius: 12px; margin-top: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">🔓 手动登录</summary>
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group" style="flex: 2;">
                            <label>密码</label>
                            <input type="password" id="loginPassword" placeholder="输入访问密码">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="success" onclick="performLogin()">🔑 登录获取Token</button>
                        </div>
                    </div>
                </details>
            </div>

            <!-- ==================== 连接设备管理页面 ==================== -->
            <div class="page-content" id="page-connections">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">🔗 连接设备管理</h3>
                    <div class="btn-group">
                        <button onclick="refreshConnectionList()">🔄 刷新</button>
                        <button class="warning" onclick="disconnectAllClients()">⚠️ 断开所有</button>
                    </div>
                </div>

                <!-- 说明信息 -->
                <div style="background: #e8f5e9; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                    <strong style="color: #2e7d32;">💡 连接管理</strong>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;">
                        显示当前通过WebSocket或TCP连接到RPC服务器的所有客户端。可以查看每个连接的详细信息，包括IP地址、连接时间、认证状态等，并可以手动断开特定连接。
                    </p>
                </div>

                <!-- 连接统计 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;">总连接数</div>
                        <div style="font-size: 32px; font-weight: bold; margin: 10px 0;" id="totalConnectionsCount">--</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;">已认证连接</div>
                        <div style="font-size: 32px; font-weight: bold; margin: 10px 0;" id="authedConnectionsCount">--</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;">WebSocket连接</div>
                        <div style="font-size: 32px; font-weight: bold; margin: 10px 0;" id="wsConnectionsCount">--</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;">TCP连接</div>
                        <div style="font-size: 32px; font-weight: bold; margin: 10px 0;" id="tcpConnectionsCount">--</div>
                    </div>
                </div>

                <!-- 连接列表 -->
                <h4 style="margin-bottom: 15px; color: #333;">📋 活动连接列表</h4>
                <div id="connectionListEmpty" class="data-list-empty" style="display: none; background: #f8f9fa; border-radius: 12px; padding: 40px 20px;">
                    <p>📭 暂无活动连接</p>
                    <p style="font-size: 12px; margin-top: 10px;">当有客户端连接时会显示在这里</p>
                </div>
                <div id="connectionListContainer">
                    <!-- 连接卡片将由JavaScript动态生成 -->
                </div>
            </div>

            <!-- ==================== 系统监控页面 ==================== -->
            <div class="page-content" id="page-monitor">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">📊 系统资源监控</h3>
                    <div class="btn-group">
                        <button onclick="refreshSystemMonitor()">🔄 刷新</button>
                        <button class="secondary" id="autoRefreshBtn" onclick="toggleAutoRefresh()">⏯️ 自动刷新</button>
                    </div>
                </div>

                <!-- 概览卡片 -->
                <div class="monitor-overview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div class="monitor-card cpu" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;">CPU 使用率</div>
                        <div style="font-size: 32px; font-weight: bold; margin: 10px 0;" id="cpuUsageValue">--</div>
                        <div style="font-size: 12px; opacity: 0.8;" id="cpuCoreInfo">-- 核心</div>
                    </div>
                    <div class="monitor-card memory" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;">内存使用</div>
                        <div style="font-size: 32px; font-weight: bold; margin: 10px 0;" id="memUsageValue">--</div>
                        <div style="font-size: 12px; opacity: 0.8;" id="memDetailInfo">-- / -- MB</div>
                    </div>
                    <div class="monitor-card storage" style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;">存储使用</div>
                        <div style="font-size: 32px; font-weight: bold; margin: 10px 0;" id="storageUsageValue">--</div>
                        <div style="font-size: 12px; opacity: 0.8;" id="storageDetailInfo">-- / -- GB</div>
                    </div>
                    <div class="monitor-card load" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;">系统负载</div>
                        <div style="font-size: 32px; font-weight: bold; margin: 10px 0;" id="loadAvgValue">--</div>
                        <div style="font-size: 12px; opacity: 0.8;" id="uptimeInfo">运行时间: --</div>
                    </div>
                </div>

                <!-- 网络和存储详情区域 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px;">
                    <!-- 网络接口详情 -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                        <h4 style="margin-bottom: 15px; color: #333;">🌐 网络接口</h4>
                        <div id="networkInterfacesList">
                            <p style="color: #999;">加载中...</p>
                        </div>
                    </div>
                    <!-- 存储详情 -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                        <h4 style="margin-bottom: 15px; color: #333;">💾 存储详情</h4>
                        <div id="storageDetailsList">
                            <p style="color: #999;">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== 传感器映射页面 ==================== -->
            <div class="page-content" id="page-sensors">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">🧭 传感器映射</h3>
                    <div class="btn-group">
                        <button onclick="refreshSensorMapping()">🔄 刷新</button>
                    </div>
                </div>

                <div style="background: #e3f2fd; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <strong style="color: #1565c0;">📌 数据映射说明</strong>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;">
                        汇总本地传感器与MQTT虚拟传感器，展示节点、来源、当前值与数据路径。
                    </p>
                </div>

                <div id="sensorMappingEmpty" class="data-list-empty" style="display: none; background: #f8f9fa; border-radius: 12px; padding: 40px 20px;">
                    <p>📭 暂无传感器数据</p>
                    <p style="font-size: 12px; margin-top: 10px;">连接服务器后点击“刷新”获取最新映射</p>
                </div>
                <div class="sensor-mapping-card" id="sensorMappingCard">
                    <div class="sensor-mapping-table-wrapper">
                        <table class="sensor-mapping-table">
                            <thead>
                                <tr>
                                    <th>传感器</th>
                                    <th>来源</th>
                                    <th>节点/通道</th>
                                    <th>数据路径</th>
                                    <th>当前值</th>
                                    <th>更新时间</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="sensorMappingTableBody">
                                <tr>
                                    <td colspan="7" class="sensor-mapping-placeholder">加载传感器映射中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ==================== 设置页面（合并连接、MQTT、Token、高级功能） ==================== -->
            <div class="page-content" id="page-settings">
                <h3 style="margin-bottom: 16px; color: #333;">⚙️ 系统设置</h3>
                
                <!-- 连接设置 -->
                <details open style="background: #f8f9fa; padding: 16px; border-radius: 10px; margin-bottom: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333; font-size: 14px;">📡 连接设置</summary>
                    <div style="margin-top: 12px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>RPC服务器地址</label>
                                <input type="text" id="settingsHost" placeholder="如: 192.168.1.100" value="">
                            </div>
                            <div class="form-group">
                                <label>RPC端口</label>
                                <input type="number" id="settingsRpcPort" placeholder="RPC端口" value="12345">
                            </div>
                            <div class="form-group">
                                <label>WS代理端口</label>
                                <input type="number" id="settingsWsPort" placeholder="WS端口" value="12346">
                            </div>
                        </div>
                        <div class="btn-group" style="margin-top: 8px;">
                            <button id="settingsWebsocatBtn" onclick="toggleWebsocatProxyFromSettings()" class="success" style="display: none;">🚀 启动代理</button>
                            <button id="settingsConnectBtn" onclick="toggleConnectionFromSettings()">🔌 连接</button>
                        </div>
                    </div>
                </details>
                
                <!-- MQTT设置 -->
                <details style="background: #e3f2fd; padding: 16px; border-radius: 10px; margin-bottom: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #1565c0; font-size: 14px;">☁️ MQTT云连接</summary>
                    <div style="margin-top: 12px;">
                        <p style="color: #666; font-size: 12px; margin-bottom: 12px;">支持多通道MQTT连接，自动推送设备状态变化。</p>
                        <div class="btn-group">
                            <button onclick="refreshMqttChannels()">🔄 刷新</button>
                            <button class="success" onclick="openAddMqttChannelModal()">➕ 添加通道</button>
                        </div>
                        <div id="mqttSettingsChannels" style="margin-top: 12px;"></div>
                    </div>
                </details>
                
                <!-- Token管理 -->
                <details style="background: #fff3e0; padding: 16px; border-radius: 10px; margin-bottom: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #e65100; font-size: 14px;">🔑 Token管理</summary>
                    <div style="margin-top: 12px;">
                        <p style="color: #666; font-size: 12px; margin-bottom: 12px;">Token用于API认证和设备授权。</p>
                        <div class="btn-group">
                            <button onclick="refreshTokenList()">🔄 刷新</button>
                            <button class="success" onclick="openCreateTokenModal()">➕ 创建Token</button>
                        </div>
                        <div id="tokenSettingsList" style="margin-top: 12px;"></div>
                    </div>
                </details>
                
                <!-- 配置管理 -->
                <details style="background: #e8f5e9; padding: 16px; border-radius: 10px; margin-bottom: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #2e7d32; font-size: 14px;">💾 配置管理</summary>
                    <div style="margin-top: 12px;">
                        <p style="color: #666; font-size: 12px; margin-bottom: 12px;">修改默认只保存在内存，重启后丢失。点击保存永久生效。</p>
                        <div class="btn-group">
                            <button class="success" onclick="saveConfig()">💾 保存配置</button>
                            <button onclick="getConfig()">📋 查看配置</button>
                            <button class="warning" onclick="reloadConfig()">🔄 重载配置</button>
                        </div>
                    </div>
                </details>
                
                <!-- 高级控制 -->
                <details style="background: #f5f5f5; padding: 16px; border-radius: 10px; margin-bottom: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333; font-size: 14px;">🛠️ 高级控制</summary>
                    <div style="margin-top: 12px;">
                        <!-- 继电器直接控制 -->
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 8px;">继电器直接控制</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>节点ID</label>
                                    <input type="number" id="advRelayNode" value="1" min="1" max="255">
                                </div>
                                <div class="form-group">
                                    <label>通道</label>
                                    <select id="advRelayChannel">
                                        <option value="0">CH0</option>
                                        <option value="1">CH1</option>
                                        <option value="2">CH2</option>
                                        <option value="3">CH3</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>动作</label>
                                    <select id="advRelayAction">
                                        <option value="stop">⏹️ 停止</option>
                                        <option value="fwd">▶️ 正转</option>
                                        <option value="rev">◀️ 反转</option>
                                    </select>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="success" onclick="controlRelayAdvanced()">⚡ 执行</button>
                                <button onclick="queryRelayAdvanced()">🔍 查询</button>
                            </div>
                        </div>
                        
                        <!-- 自定义RPC -->
                        <div style="padding-top: 12px; border-top: 1px solid #ddd;">
                            <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 8px;">自定义RPC调用</div>
                            <div class="form-group">
                                <label>方法名</label>
                                <input type="text" id="advMethodName" placeholder="如: rpc.ping">
                            </div>
                            <div class="form-group">
                                <label>参数 (JSON)</label>
                                <textarea id="advMethodParams" placeholder='{"node": 1}' style="height: 60px;">{}</textarea>
                            </div>
                            <button onclick="callCustomMethodAdvanced()">🚀 发送</button>
                        </div>
                    </div>
                </details>
                
                <!-- 蓝图编辑器入口 -->
                <details style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); padding: 16px; border-radius: 10px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #00796b; font-size: 14px;">🎨 可视化蓝图</summary>
                    <div style="margin-top: 12px;">
                        <p style="color: #666; font-size: 12px; margin-bottom: 12px;">通过拖放方式创建自动化策略流程。</p>
                        <button class="success" onclick="showPage('blueprint')">打开蓝图编辑器</button>
                    </div>
                </details>
            </div>

            <!-- ==================== 蓝图编辑器页面 ==================== -->
            <div class="page-content" id="page-blueprint">
                <h3 style="margin-bottom: 15px; color: #333;">🎨 可视化蓝图编辑器</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                    通过拖放方式创建自动化策略。将左侧的触发器和动作节点拖到画布上，然后连接它们来创建策略流程。
                </p>
                
                <!-- 蓝图编辑器主容器 -->
                <div class="blueprint-editor">
                    <!-- 左侧节点面板 -->
                    <div class="node-palette">
                        <div class="palette-title">📦 节点工具箱</div>
                        
                        <!-- 触发器类型 -->
                        <div class="palette-category">
                            <div class="palette-category-title">🔔 触发器</div>
                            <div class="palette-item" draggable="true" data-node-type="trigger-time">
                                <span class="item-icon">⏰</span>
                                <span class="item-name">定时触发器</span>
                            </div>
                            <div class="palette-item" draggable="true" data-node-type="trigger-sensor">
                                <span class="item-icon">📡</span>
                                <span class="item-name">传感器触发</span>
                            </div>
                        </div>
                        
                        <!-- 动作类型 -->
                        <div class="palette-category">
                            <div class="palette-category-title">⚡ 动作</div>
                            <div class="palette-item" draggable="true" data-node-type="action-relay">
                                <span class="item-icon">🎛️</span>
                                <span class="item-name">继电器控制</span>
                            </div>
                            <div class="palette-item" draggable="true" data-node-type="action-group">
                                <span class="item-icon">📦</span>
                                <span class="item-name">分组控制</span>
                            </div>
                        </div>
                        
                        <!-- 显示类型 -->
                        <div class="palette-category">
                            <div class="palette-category-title">📊 展示</div>
                            <div class="palette-item" draggable="true" data-node-type="device">
                                <span class="item-icon">🔌</span>
                                <span class="item-name">设备节点</span>
                            </div>
                            <div class="palette-item" draggable="true" data-node-type="group">
                                <span class="item-icon">📂</span>
                                <span class="item-name">分组节点</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 中间画布区域 -->
                    <div class="blueprint-canvas-container">
                        <!-- 工具栏 -->
                        <div class="canvas-toolbar">
                            <button onclick="clearBlueprint()" title="删除所有节点和连线">🗑️ 清空画布</button>
                            <button class="success" onclick="deployBlueprintStrategies()" title="将蓝图转换为实际的RPC策略">🚀 部署策略</button>
                            <button class="warning" onclick="loadExistingStrategies()" title="从服务器读取已有的策略并显示在画布上">📋 读取策略</button>
                            <button class="secondary" onclick="generateSystemDiagram()" title="从服务器读取设备和分组信息">📊 生成系统框图</button>
                            <button onclick="downloadBlueprint()" title="将蓝图保存为JSON文件">💾 导出蓝图</button>
                            <button onclick="uploadBlueprint()" title="从JSON文件导入蓝图">📂 导入蓝图</button>
                        </div>
                        
                        <!-- 蓝图画布 -->
                        <div class="blueprint-canvas" id="blueprintCanvas">
                            <!-- 空状态提示 -->
                            <div class="canvas-empty-hint" id="canvasEmptyHint">
                                <div class="hint-icon">🎨</div>
                                <div class="hint-text">
                                    从左侧拖放节点到此处<br>
                                    创建您的自动化策略
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧属性面板 -->
                    <div class="node-properties-panel" id="nodePropertiesPanel">
                        <div class="properties-header">
                            <span class="prop-icon">⚙️</span>
                            <span class="prop-title">节点属性</span>
                        </div>
                        <div class="properties-content">
                            <p class="prop-description">选择一个节点查看和编辑其属性</p>
                        </div>
                    </div>
                </div>
                
                <!-- 简化使用说明 -->
                <details style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #666;">📖 使用说明（点击展开）</summary>
                    <ul style="margin-top: 10px; color: #666; font-size: 13px; line-height: 1.8;">
                        <li><strong>添加节点：</strong>从左侧工具箱拖放到画布</li>
                        <li><strong>连接：</strong>拖动输出端口（橙色）到输入端口（绿色）</li>
                        <li><strong>配置：</strong>点击节点在右侧面板编辑属性</li>
                        <li><strong>部署：</strong>点击"部署策略"将蓝图转换为实际策略</li>
                        <li><strong>读取：</strong>点击"读取策略"从服务器加载现有策略</li>
                    </ul>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                        <strong style="color: #333;">⌨️ 键盘快捷键：</strong>
                        <span style="margin-left: 10px;">Delete=删除 | Ctrl+D=复制 | Shift+拖拽=精确定位 | Esc=取消选择</span>
                    </div>
                </details>
            </div>

            </div><!-- 结束 .card -->
        </div><!-- 结束 .content-area -->

        <!-- ==================== 右侧通信日志面板 ==================== -->
        <div class="log-sidebar">
            <div class="card log-card">
                <h2>📝 通信日志</h2>
                <div style="margin-bottom: 15px;">
                    <button class="secondary" onclick="clearLog()">🗑️ 清空日志</button>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-placeholder">等待操作...</div>
                </div>
            </div>
        </div><!-- 结束 .log-sidebar -->
    </div><!-- 结束 .main-layout -->

    <!-- ==================== 弹窗组件 ==================== -->
    
    <!-- 创建分组弹窗 -->
    <div class="modal-overlay" id="groupModal" onclick="closeModalOnBackground(event, 'groupModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h3>➕ 创建新分组</h3>
                <button class="modal-close" onclick="closeModal('groupModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>分组ID</label>
                    <input type="number" id="newGroupId" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>分组名称（可留空自动生成）</label>
                    <input type="text" id="newGroupName" placeholder="例如: main-group">
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('groupModal')">取消</button>
                <button class="success" onclick="createGroup()">➕ 创建分组</button>
            </div>
        </div>
    </div>

    <!-- 管理设备弹窗 -->
    <div class="modal-overlay" id="manageDeviceModal" onclick="closeModalOnBackground(event, 'manageDeviceModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🔗 管理分组设备</h3>
                <button class="modal-close" onclick="closeModal('manageDeviceModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>分组ID</label>
                        <input type="number" id="addDeviceGroupId" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>设备节点ID</label>
                        <input type="number" id="addDeviceNodeId" value="1" min="1" max="255">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('manageDeviceModal')">关闭</button>
                <button class="danger" onclick="removeDeviceFromGroup()">➖ 移除设备</button>
                <button class="success" onclick="addDeviceToGroup()">➕ 添加设备</button>
            </div>
        </div>
    </div>

    <!-- 管理设备通道弹窗 - 新增，支持按通道绑定 -->
    <div class="modal-overlay" id="manageChannelModal" onclick="closeModalOnBackground(event, 'manageChannelModal')">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);">
                <h3>🔧 管理设备通道</h3>
                <button class="modal-close" onclick="closeModal('manageChannelModal')">✕</button>
            </div>
            <div class="modal-body">
                <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #1565c0;">
                    💡 <strong>提示：</strong>可以将设备的单个通道添加到分组，同一设备的不同通道可以绑定到不同分组。
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>分组ID</label>
                        <input type="number" id="channelGroupId" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>设备节点ID</label>
                        <input type="number" id="channelNodeId" value="1" min="1" max="255">
                    </div>
                    <div class="form-group">
                        <label>通道</label>
                        <select id="channelNumber">
                            <option value="0">通道 0</option>
                            <option value="1">通道 1</option>
                            <option value="2">通道 2</option>
                            <option value="3">通道 3</option>
                        </select>
                    </div>
                </div>
                <div id="channelListDisplay" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; display: none;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">当前分组的通道列表：</div>
                    <div id="channelListContent" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('manageChannelModal')">关闭</button>
                <button onclick="viewGroupChannels()">📋 查看通道</button>
                <button class="danger" onclick="removeChannelFromGroup()">➖ 移除通道</button>
                <button class="success" onclick="addChannelToGroup()">➕ 添加通道</button>
            </div>
        </div>
    </div>

    <!-- 创建定时策略弹窗 - 优化版 -->
    <!-- 场景编辑器弹窗（泛舟云协议） -->
    <div class="modal-overlay" id="sceneEditorModal" onclick="closeModalOnBackground(event, 'sceneEditorModal')">
        <div class="modal-content modal-large" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h3 id="sceneEditorTitle">✨ 创建新场景</h3>
                <button class="modal-close" onclick="closeModal('sceneEditorModal')">✕</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- 场景基本信息 -->
                <div style="background: #f8f9fa; padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                    <div style="font-weight: 600; color: #333; margin-bottom: 12px;">📝 基本信息</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>场景ID <span style="color: #999; font-size: 11px;">（新建时留空）</span></label>
                            <input type="number" id="sceneId" placeholder="自动分配" min="1">
                        </div>
                        <div class="form-group">
                            <label>场景名称 <span style="color: #c62828;">*</span></label>
                            <input type="text" id="sceneName" placeholder="例如：高温通风">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>场景类型</label>
                            <select id="sceneType" onchange="toggleSceneConditions()">
                                <option value="auto">🤖 自动场景 (auto)</option>
                                <option value="manual">👆 手动场景 (manual)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>触发方式</label>
                            <select id="sceneMatchType">
                                <option value="0">全部满足 (AND)</option>
                                <option value="1">任一满足 (OR)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>状态</label>
                            <select id="sceneStatus">
                                <option value="0">✅ 启用</option>
                                <option value="1">❌ 禁用</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>生效开始时间</label>
                            <input type="time" id="sceneEffectiveBeginTime" value="00:00">
                        </div>
                        <div class="form-group">
                            <label>生效结束时间</label>
                            <input type="time" id="sceneEffectiveEndTime" value="23:59">
                        </div>
                    </div>
                </div>

                <!-- 触发条件 -->
                <div id="sceneConditionsSection" style="background: #fff3e0; padding: 16px; border-radius: 10px; margin-bottom: 16px; border-left: 4px solid #ff9800;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #333;">📊 触发条件</span>
                        <button onclick="addSceneCondition()" class="secondary" style="padding: 4px 10px; font-size: 11px;">+ 添加条件</button>
                    </div>
                    <div id="sceneConditionsList">
                        <!-- 条件列表将由JavaScript动态生成 -->
                        <div class="scene-condition-item" style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                            <div class="form-row" style="margin-bottom: 0;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 11px;">设备编码</label>
                                    <input type="text" class="cond-device-code" placeholder="864708069172099" style="font-size: 12px;">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 11px;">属性标识</label>
                                    <select class="cond-identifier" style="font-size: 12px;">
                                        <option value="airTemp">🌡️ 空气温度</option>
                                        <option value="airHum">💧 空气湿度</option>
                                        <option value="light">☀️ 光照强度</option>
                                        <option value="co2">🌫️ CO₂浓度</option>
                                        <option value="soilTemp">🌱 土壤温度</option>
                                        <option value="soilHum">🌾 土壤湿度</option>
                                        <option value="soilEC">⚡ 土壤EC</option>
                                        <option value="ph">🧪 PH值</option>
                                        <option value="do">💨 溶解氧</option>
                                        <option value="windSpeed">🌬️ 风速</option>
                                        <option value="pressure">📊 气压</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 11px;">操作符</label>
                                    <select class="cond-op" style="font-size: 12px;">
                                        <option value="gt">大于 (&gt;)</option>
                                        <option value="lt">小于 (&lt;)</option>
                                        <option value="egt">大于等于 (≥)</option>
                                        <option value="elt">小于等于 (≤)</option>
                                        <option value="eq">等于 (=)</option>
                                        <option value="ne">不等于 (≠)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 11px;">阈值</label>
                                    <input type="number" class="cond-value" value="30" step="0.1" style="font-size: 12px;">
                                </div>
                                <button onclick="removeSceneCondition(this)" class="danger" style="padding: 6px 10px; font-size: 11px; align-self: flex-end;">✕</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 执行动作 -->
                <div style="background: #e8f5e9; padding: 16px; border-radius: 10px; border-left: 4px solid #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #333;">⚡ 执行动作</span>
                        <button onclick="addSceneAction()" class="secondary" style="padding: 4px 10px; font-size: 11px;">+ 添加动作</button>
                    </div>
                    <div id="sceneActionsList">
                        <!-- 动作列表将由JavaScript动态生成 -->
                        <div class="scene-action-item" style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                            <div class="form-row" style="margin-bottom: 0;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 11px;">属性标识 <span style="color: #999;">(node_X_swY)</span></label>
                                    <input type="text" class="action-identifier" placeholder="node_1_sw1" style="font-size: 12px;">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 11px;">动作值</label>
                                    <select class="action-value" style="font-size: 12px;">
                                        <option value="0">⏹️ 停止 (0)</option>
                                        <option value="1">▶️ 正转 (1)</option>
                                        <option value="2">◀️ 反转 (2)</option>
                                    </select>
                                </div>
                                <button onclick="removeSceneAction(this)" class="danger" style="padding: 6px 10px; font-size: 11px; align-self: flex-end;">✕</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('sceneEditorModal')">取消</button>
                <button class="warning" onclick="previewSceneJson()">📋 预览JSON</button>
                <button class="success" onclick="saveScene()">💾 保存场景</button>
            </div>
        </div>
    </div>

    <!-- 定时器编辑器弹窗 -->
    <div class="modal-overlay" id="timerEditorModal" onclick="closeModalOnBackground(event, 'timerEditorModal')">
        <div class="modal-content modal-large" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #9c27b0 0%, #e040fb 100%);">
                <h3 id="timerEditorTitle">⏰ 创建定时器</h3>
                <button class="modal-close" onclick="closeModal('timerEditorModal')">✕</button>
            </div>
            <div class="modal-body">
                <div style="background: #f3e5f5; padding: 14px; border-radius: 10px; margin-bottom: 16px; border-left: 4px solid #9c27b0;">
                    <strong style="color: #7b1fa2;">💡 定时器说明</strong>
                    <p style="font-size: 12px; color: #666; margin-top: 6px;">定时器会在指定时间或间隔自动执行动作，支持每日定时和间隔执行两种模式。</p>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>定时器ID</label>
                        <input type="number" id="timerId" placeholder="自动分配" min="1">
                    </div>
                    <div class="form-group">
                        <label>定时器名称 <span style="color: #c62828;">*</span></label>
                        <input type="text" id="timerName" placeholder="例如：每日浇水">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>触发类型</label>
                        <select id="timerTriggerType" onchange="toggleTimerInputs()">
                            <option value="interval">⏱️ 间隔执行</option>
                            <option value="daily">📅 每日定时</option>
                        </select>
                    </div>
                    <div class="form-group" id="timerIntervalGroup">
                        <label>执行间隔（秒）</label>
                        <input type="number" id="timerInterval" value="3600" min="1">
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">3600秒=1小时</div>
                    </div>
                    <div class="form-group" id="timerDailyGroup" style="display: none;">
                        <label>每日执行时间</label>
                        <input type="time" id="timerDailyTime" value="08:00">
                    </div>
                </div>
                
                <div style="background: #e8f5e9; padding: 14px; border-radius: 10px; border-left: 4px solid #4caf50;">
                    <div style="font-weight: 600; color: #333; margin-bottom: 10px;">⚡ 执行动作</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>属性标识</label>
                            <input type="text" id="timerActionIdentifier" placeholder="node_1_sw1">
                        </div>
                        <div class="form-group">
                            <label>动作值</label>
                            <select id="timerActionValue">
                                <option value="0">⏹️ 停止 (0)</option>
                                <option value="1">▶️ 正转 (1)</option>
                                <option value="2">◀️ 反转 (2)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>状态</label>
                            <select id="timerStatus">
                                <option value="0">✅ 启用</option>
                                <option value="1">❌ 禁用</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('timerEditorModal')">取消</button>
                <button class="success" onclick="saveTimer()">💾 保存定时器</button>
            </div>
        </div>
    </div>

    <!-- JSON预览弹窗 -->
    <div class="modal-overlay" id="jsonPreviewModal" onclick="closeModalOnBackground(event, 'jsonPreviewModal')">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>📋 JSON预览</h3>
                <button class="modal-close" onclick="closeModal('jsonPreviewModal')">✕</button>
            </div>
            <div class="modal-body">
                <div style="background: #1e1e1e; border-radius: 8px; padding: 16px; max-height: 400px; overflow-y: auto;">
                    <pre id="jsonPreviewContent" style="color: #d4d4d4; font-family: 'Fira Code', 'Consolas', monospace; font-size: 12px; margin: 0; white-space: pre-wrap; word-break: break-all;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="copyJsonToClipboard()" class="secondary">📋 复制</button>
                <button onclick="closeModal('jsonPreviewModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 保留旧的定时策略弹窗以兼容 -->
    <div class="modal-overlay" id="strategyModal" onclick="closeModalOnBackground(event, 'strategyModal')">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>⏱️ 创建定时策略</h3>
                <button class="modal-close" onclick="closeModal('strategyModal')">✕</button>
            </div>
            <div class="modal-body">
                <!-- 提示信息 -->
                <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #1565c0;">
                    💡 <strong>提示：</strong>定时策略会按照设定的时间间隔自动执行指定动作。策略会控制分组中绑定的所有通道。请先在分组中配置需要控制的通道。
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>策略ID <span style="color: #999; font-size: 11px;">（自动生成）</span></label>
                        <input type="number" id="newStrategyId" value="1" min="1" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>策略名称 <span style="color: #999; font-size: 11px;">（可选）</span></label>
                        <input type="text" id="newStrategyName" placeholder="留空自动生成">
                    </div>
                    <div class="form-group">
                        <label>绑定分组ID <span style="color: #c62828; font-size: 11px;">*必填</span></label>
                        <input type="number" id="newStrategyGroupId" value="1" min="1">
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">策略将控制该分组绑定的所有通道</div>
                    </div>
                </div>
                <!-- 隐藏的通道字段，默认值为-1（使用分组绑定的通道） -->
                <input type="hidden" id="newStrategyChannel" value="-1">
                <div class="form-row">
                    <div class="form-group">
                        <label>执行动作</label>
                        <select id="newStrategyAction">
                            <option value="fwd">▶️ 正转（启动）</option>
                            <option value="stop">⏹️ 停止</option>
                            <option value="rev">◀️ 反转</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>自动启动</label>
                        <select id="newStrategyAutoStart">
                            <option value="true">✅ 是</option>
                            <option value="false">❌ 否</option>
                        </select>
                    </div>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>触发方式</label>
                            <select id="newStrategyTriggerType" onchange="toggleTimerTypeInputs()">
                                <option value="interval">⏱️ 间隔执行</option>
                                <option value="daily">📅 每日定时</option>
                            </select>
                        </div>
                        <div class="form-group" id="intervalInputGroup">
                            <label>执行间隔（秒）</label>
                            <input type="number" id="newStrategyInterval" value="3600" min="1">
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">常用：60=1分钟, 3600=1小时, 86400=1天</div>
                        </div>
                        <div class="form-group" id="dailyTimeInputGroup" style="display: none;">
                            <label>每日执行时间</label>
                            <input type="time" id="newStrategyDailyTime" value="08:00">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('strategyModal')">取消</button>
                <button class="success" onclick="createTimerStrategyAndClose()">➕ 创建策略</button>
            </div>
        </div>
    </div>

    <!-- 创建传感器策略弹窗 - 优化版 -->
    <div class="modal-overlay" id="sensorStrategyModal" onclick="closeModalOnBackground(event, 'sensorStrategyModal')">
        <div class="modal-content modal-large">
            <div class="modal-header" style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);">
                <h3>📡 创建传感器策略</h3>
                <button class="modal-close" onclick="closeModal('sensorStrategyModal')">✕</button>
            </div>
            <div class="modal-body">
                <!-- 提示信息 -->
                <div style="background: #fff3e0; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #e65100;">
                    💡 <strong>提示：</strong>传感器策略会在传感器数值满足条件时自动执行。策略会控制分组中绑定的所有通道。请先在分组中配置需要控制的通道。
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>策略ID <span style="color: #999; font-size: 11px;">（自动生成）</span></label>
                        <input type="number" id="sensorStrategyId" value="1" min="1" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>策略名称 <span style="color: #999; font-size: 11px;">（可选）</span></label>
                        <input type="text" id="sensorStrategyName" placeholder="留空自动生成">
                    </div>
                    <div class="form-group">
                        <label>传感器类型</label>
                        <select id="sensorType">
                            <option value="temperature">🌡️ 温度</option>
                            <option value="humidity">💧 湿度</option>
                            <option value="light">💡 光照</option>
                            <option value="soil_moisture">🌱 土壤湿度</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>传感器节点</label>
                        <input type="number" id="sensorNodeId" value="1" min="1" max="255">
                    </div>
                </div>
                
                <!-- 触发条件区域 -->
                <div style="background: #fafafa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #e67e22;">
                    <div style="font-weight: 600; color: #333; margin-bottom: 10px;">📊 触发条件设置</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>当传感器数值</label>
                            <select id="sensorCondition">
                                <option value="gt">大于 (>) - 超过阈值时触发</option>
                                <option value="lt">小于 (&lt;) - 低于阈值时触发</option>
                                <option value="gte">大于等于 (≥)</option>
                                <option value="lte">小于等于 (≤)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>阈值</label>
                            <input type="number" id="sensorThreshold" value="30" step="0.1">
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">例如：温度30表示30°C</div>
                        </div>
                    </div>
                </div>
                
                <!-- 执行动作区域 -->
                <!-- 隐藏的通道字段，默认值为-1（使用分组绑定的通道） -->
                <input type="hidden" id="sensorChannel" value="-1">
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <div style="font-weight: 600; color: #333; margin-bottom: 10px;">⚡ 执行动作设置</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>控制分组ID <span style="color: #c62828; font-size: 11px;">*必填</span></label>
                            <input type="number" id="sensorGroupId" value="1" min="1">
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">策略将控制该分组绑定的所有通道</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>执行动作</label>
                            <select id="sensorAction">
                                <option value="fwd">▶️ 正转（启动设备）</option>
                                <option value="stop">⏹️ 停止</option>
                                <option value="rev">◀️ 反转</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>冷却时间（秒）</label>
                            <input type="number" id="sensorCooldown" value="60" min="0">
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">触发后多久才能再次触发</div>
                        </div>
                        <div class="form-group">
                            <label>启用</label>
                            <select id="sensorEnabled">
                                <option value="true">✅ 是</option>
                                <option value="false">❌ 否</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('sensorStrategyModal')">取消</button>
                <button class="success" onclick="createSensorStrategyAndClose()">➕ 创建策略</button>
            </div>
        </div>
    </div>

    <!-- 简化策略向导弹窗 - 新手友好的创建方式 -->
    <div class="modal-overlay" id="simpleStrategyWizard" onclick="closeModalOnBackground(event, 'simpleStrategyWizard')">
        <div class="modal-content modal-large">
            <div class="modal-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <h3>✨ 简易策略向导</h3>
                <button class="modal-close" onclick="closeModal('simpleStrategyWizard')">✕</button>
            </div>
            <div class="modal-body">
                <!-- 步骤1：选择策略类型 -->
                <div id="wizardStep1">
                    <h4 style="margin-bottom: 15px; color: #333;">第1步：选择策略类型</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="wizard-option" onclick="selectWizardType('timer')" style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; cursor: pointer; text-align: center; transition: all 0.3s;" id="wizardTypeTimer">
                            <div style="font-size: 36px; margin-bottom: 10px;">⏰</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">定时策略</div>
                            <div style="font-size: 12px; color: #666;">按时间间隔或每天固定时间执行</div>
                        </div>
                        <div class="wizard-option" onclick="selectWizardType('sensor')" style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; cursor: pointer; text-align: center; transition: all 0.3s;" id="wizardTypeSensor">
                            <div style="font-size: 36px; margin-bottom: 10px;">📡</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">传感器策略</div>
                            <div style="font-size: 12px; color: #666;">当传感器数值达到条件时执行</div>
                        </div>
                    </div>
                </div>

                <!-- 步骤2：配置策略（定时） -->
                <div id="wizardStep2Timer" style="display: none;">
                    <h4 style="margin-bottom: 15px; color: #333;">第2步：配置定时策略</h4>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                        <div class="form-group">
                            <label>📝 策略名称 <span style="color: #999; font-size: 12px;">（可选，留空自动生成）</span></label>
                            <input type="text" id="wizardTimerName" placeholder="例如：定时通风">
                        </div>
                        <!-- 隐藏的通道字段，默认值为-1（使用分组绑定的通道） -->
                        <input type="hidden" id="wizardTimerChannel" value="-1">
                        <div class="form-row">
                            <div class="form-group">
                                <label>📂 绑定分组ID</label>
                                <input type="number" id="wizardTimerGroupId" value="1" min="1">
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">策略将控制该分组绑定的所有通道</div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>⚡ 执行动作</label>
                                <select id="wizardTimerAction">
                                    <option value="fwd">▶️ 正转（启动）</option>
                                    <option value="stop">⏹️ 停止</option>
                                    <option value="rev">◀️ 反转</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>🔄 触发类型</label>
                                <select id="wizardTimerTriggerType" onchange="toggleWizardTimerTypeInputs()">
                                    <option value="interval">按间隔执行</option>
                                    <option value="daily">每日定时执行</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" id="wizardIntervalInputGroup">
                                <label>⏱️ 执行间隔（秒）</label>
                                <input type="number" id="wizardTimerInterval" value="3600" min="1">
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">3600秒 = 1小时</div>
                            </div>
                            <div class="form-group" id="wizardDailyTimeInputGroup" style="display: none;">
                                <label>📅 每日执行时间</label>
                                <input type="time" id="wizardTimerDailyTime" value="08:00">
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">格式：HH:MM（24小时制）</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 步骤2：配置策略（传感器） -->
                <div id="wizardStep2Sensor" style="display: none;">
                    <h4 style="margin-bottom: 15px; color: #333;">第2步：配置传感器策略</h4>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                        <div class="form-group">
                            <label>📝 策略名称 <span style="color: #999; font-size: 12px;">（可选，留空自动生成）</span></label>
                            <input type="text" id="wizardSensorName" placeholder="例如：高温自动降温">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>🌡️ 传感器类型</label>
                                <select id="wizardSensorType">
                                    <option value="temperature">🌡️ 温度</option>
                                    <option value="humidity">💧 湿度</option>
                                    <option value="light">💡 光照</option>
                                    <option value="soil_moisture">🌱 土壤湿度</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>📍 传感器节点</label>
                                <input type="number" id="wizardSensorNode" value="1" min="1" max="255">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>📊 触发条件</label>
                                <select id="wizardSensorCondition">
                                    <option value="gt">大于 (>) - 超过阈值时触发</option>
                                    <option value="lt">小于 (&lt;) - 低于阈值时触发</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>🎯 阈值</label>
                                <input type="number" id="wizardSensorThreshold" value="30" step="0.1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>📂 控制分组ID</label>
                                <input type="number" id="wizardSensorGroupId" value="1" min="1">
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">策略将控制该分组绑定的所有通道</div>
                            </div>
                            <div class="form-group">
                                <label>⚡ 执行动作</label>
                                <select id="wizardSensorAction">
                                    <option value="fwd">▶️ 正转（启动）</option>
                                    <option value="stop">⏹️ 停止</option>
                                    <option value="rev">◀️ 反转</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('simpleStrategyWizard')">取消</button>
                <button class="success" onclick="submitWizardStrategy()" id="wizardSubmitBtn" style="display: none;">✅ 创建策略</button>
            </div>
        </div>
    </div>

    <!-- 添加MQTT通道弹窗 -->
    <div class="modal-overlay" id="mqttChannelModal" onclick="closeModalOnBackground(event, 'mqttChannelModal')">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>☁️ 添加MQTT通道</h3>
                <button class="modal-close" onclick="closeModal('mqttChannelModal')">✕</button>
            </div>
            <div class="modal-body">
                <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #1565c0;">
                    💡 <strong>提示：</strong>MQTT通道用于连接云平台，当设备状态变化时自动推送消息。支持多个通道同时连接不同的Broker。
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>通道ID <span style="color: #c62828;">*</span></label>
                        <input type="number" id="mqttChannelId" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>通道名称</label>
                        <input type="text" id="mqttChannelName" placeholder="例如：阿里云IoT">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>Broker地址 <span style="color: #c62828;">*</span></label>
                        <input type="text" id="mqttBroker" placeholder="例如：mqtt.example.com">
                    </div>
                    <div class="form-group">
                        <label>端口</label>
                        <input type="number" id="mqttPort" value="1883" min="1" max="65535">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>客户端ID</label>
                        <input type="text" id="mqttClientId" placeholder="留空自动生成">
                    </div>
                    <div class="form-group">
                        <label>主题前缀</label>
                        <input type="text" id="mqttTopicPrefix" placeholder="例如：fanzhou/device/">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>用户名（可选）</label>
                        <input type="text" id="mqttUsername" placeholder="MQTT认证用户名">
                    </div>
                    <div class="form-group">
                        <label>密码（可选）</label>
                        <input type="password" id="mqttPassword" placeholder="MQTT认证密码">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>心跳间隔（秒）</label>
                        <input type="number" id="mqttKeepAlive" value="60" min="10" max="3600">
                    </div>
                    <div class="form-group">
                        <label>QoS级别</label>
                        <select id="mqttQos">
                            <option value="0">0 - 最多一次</option>
                            <option value="1">1 - 至少一次</option>
                            <option value="2">2 - 恰好一次</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>自动重连</label>
                        <select id="mqttAutoReconnect">
                            <option value="true">✅ 是</option>
                            <option value="false">❌ 否</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('mqttChannelModal')">取消</button>
                <button class="success" onclick="addMqttChannel()">➕ 添加通道</button>
            </div>
        </div>
    </div>

    <!-- 创建Token弹窗 -->
    <div class="modal-overlay" id="createTokenModal" onclick="closeModalOnBackground(event, 'createTokenModal')">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h3>🔑 创建新Token</h3>
                <button class="modal-close" onclick="closeModal('createTokenModal')">✕</button>
            </div>
            <div class="modal-body">
                <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #1565c0;">
                    💡 <strong>提示：</strong>Token创建后请立即保存，关闭弹窗后将无法再次查看完整Token。
                </div>
                <div class="form-group">
                    <label>Token名称</label>
                    <input type="text" id="newTokenName" placeholder="例如: API Token" value="API Token">
                </div>
                <div class="form-group">
                    <label>有效期（小时）</label>
                    <input type="number" id="newTokenExpireHours" value="24" min="1" max="8760">
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">最长365天 (8760小时)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('createTokenModal')">取消</button>
                <button class="success" onclick="createTokenFromModal()">🔑 创建Token</button>
            </div>
        </div>
    </div>

    <!-- Token显示弹窗 -->
    <div class="modal-overlay" id="showTokenModal" onclick="closeModalOnBackground(event, 'showTokenModal')">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">
                <h3>✅ Token创建成功</h3>
                <button class="modal-close" onclick="closeModal('showTokenModal')">✕</button>
            </div>
            <div class="modal-body">
                <div style="background: #fff3e0; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #e65100; border-left: 4px solid #ff9800;">
                    ⚠️ <strong>重要：</strong>请立即复制并妥善保存此Token。关闭此弹窗后将无法再次查看完整Token。
                </div>
                <div class="form-group">
                    <label>您的新Token</label>
                    <div style="position: relative;">
                        <input type="password" id="generatedTokenDisplay" readonly style="background: #f5f5f5; font-family: monospace; padding-right: 140px;">
                        <button onclick="toggleTokenVisibility()" style="position: absolute; right: 80px; top: 50%; transform: translateY(-50%); min-width: 60px; padding: 8px;" id="toggleTokenBtn">👁️ 显示</button>
                        <button onclick="copyGeneratedToken()" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); min-width: 70px; padding: 8px;">📋 复制</button>
                    </div>
                </div>
                <div id="tokenCopyStatus" style="text-align: center; color: #2e7d32; display: none; margin-top: 10px;">
                    ✅ 已复制到剪贴板
                </div>
            </div>
            <div class="modal-footer">
                <button class="success" onclick="closeModal('showTokenModal')">✓ 我已保存Token</button>
            </div>
        </div>
    </div>

    <!-- 引入外部JavaScript -->
    <script src="js/app.js"></script>
    <script src="js/blueprint.js"></script>
</body>
</html>
