<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³›èˆŸRPC - å¼€å‘è€…è°ƒè¯•å·¥å…·</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* è°ƒè¯•é¡µé¢ä¸“ç”¨æ ·å¼ */
        .debug-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .debug-header {
            background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .debug-header h1 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .debug-header .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .debug-header .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .debug-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .debug-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .debug-card-header {
            padding: 15px 20px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .debug-card-body {
            padding: 15px 20px;
        }
        
        .debug-card.sensor-debug .debug-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .debug-card.rpc-debug .debug-card-header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .debug-card.system-debug .debug-card-header {
            background: linear-gradient(135deg, #e65100 0%, #ff9800 100%);
            color: white;
        }
        
        .debug-card.log-debug .debug-card-header {
            background: linear-gradient(135deg, #1565c0 0%, #42a5f5 100%);
            color: white;
        }
        
        .debug-card.mqtt-debug .debug-card-header {
            background: linear-gradient(135deg, #c62828 0%, #ef5350 100%);
            color: white;
        }
        
        .debug-card.config-debug .debug-card-header {
            background: linear-gradient(135deg, #00695c 0%, #26a69a 100%);
            color: white;
        }
        
        .debug-form-group {
            margin-bottom: 12px;
        }
        
        .debug-form-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .debug-form-group input,
        .debug-form-group select,
        .debug-form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
        }
        
        .debug-form-group textarea {
            min-height: 80px;
            font-family: 'Fira Code', 'Consolas', monospace;
        }
        
        .debug-form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .debug-btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .debug-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .debug-btn.primary {
            background: #667eea;
            color: white;
        }
        
        .debug-btn.success {
            background: #4caf50;
            color: white;
        }
        
        .debug-btn.warning {
            background: #ff9800;
            color: white;
        }
        
        .debug-btn.danger {
            background: #f44336;
            color: white;
        }
        
        .debug-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .debug-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 12px;
        }
        
        .debug-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 6px;
            background: #f5f5f5;
        }
        
        .debug-status.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .debug-status.disconnected {
            background: #ffebee;
            color: #c62828;
        }
        
        .quick-value-btn {
            padding: 6px 10px;
            font-size: 11px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .quick-value-btn:hover {
            background: #f5f5f5;
        }
        
        .connection-bar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .connection-bar input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .connection-bar .host-input {
            width: 180px;
        }
        
        .connection-bar .port-input {
            width: 80px;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <!-- å¤´éƒ¨ -->
        <div class="debug-header">
            <h1>ğŸ”§ å¼€å‘è€…è°ƒè¯•å·¥å…·</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span class="debug-status disconnected" id="connectionStatus">
                    <span>â—</span>
                    <span>æœªè¿æ¥</span>
                </span>
                <button class="back-btn" onclick="window.location.href='index.html'">â† è¿”å›ä¸»é¡µ</button>
            </div>
        </div>
        
        <!-- è¿æ¥æ  -->
        <div class="connection-bar">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 13px; color: #666;">ğŸ“¡ RPCæœåŠ¡å™¨:</span>
                <input type="text" id="serverHost" class="host-input" placeholder="è®¾å¤‡IP" value="">
                <span>:</span>
                <input type="number" id="rpcPort" class="port-input" value="12345">
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 13px; color: #666;">WSç«¯å£:</span>
                <input type="number" id="wsPort" class="port-input" value="12346">
            </div>
            <button id="websocatToggleBtn" onclick="toggleWebsocatProxy()" class="debug-btn success" style="display: none;">ğŸš€ å¯åŠ¨ä»£ç†</button>
            <button id="connectBtn" onclick="toggleConnection()" class="debug-btn primary">ğŸ”Œ è¿æ¥</button>
        </div>
        
        <!-- è°ƒè¯•å¡ç‰‡ç½‘æ ¼ -->
        <div class="debug-grid">
            <!-- ä¼ æ„Ÿå™¨æ¨¡æ‹Ÿè°ƒè¯• -->
            <div class="debug-card sensor-debug">
                <div class="debug-card-header">
                    ğŸ“¡ ä¼ æ„Ÿå™¨æ•°æ®æ¨¡æ‹Ÿ
                </div>
                <div class="debug-card-body">
                    <div class="debug-form-row">
                        <div class="debug-form-group">
                            <label>è®¾å¤‡ç¼–ç </label>
                            <input type="text" id="debugDeviceCode" value="864708069172099" placeholder="è®¾å¤‡ç¼–ç ">
                        </div>
                        <div class="debug-form-group">
                            <label>å±æ€§æ ‡è¯†</label>
                            <input type="text" id="debugIdentifier" value="airTemp" placeholder="å¦‚: airTemp">
                        </div>
                        <div class="debug-form-group">
                            <label>æ•°å€¼</label>
                            <input type="number" id="debugIdentifierValue" value="25" step="0.1">
                        </div>
                    </div>
                    
                    <div style="margin: 10px 0; font-size: 12px; color: #666;">
                        <strong>å¸¸ç”¨å±æ€§:</strong> airTemp(ç©ºæ°”æ¸©åº¦), airHum(ç©ºæ°”æ¹¿åº¦), soilTemp(åœŸå£¤æ¸©åº¦), soilHum(åœŸå£¤æ¹¿åº¦), light(å…‰ç…§), co2(COâ‚‚)
                    </div>
                    
                    <div class="debug-btn-group">
                        <button class="debug-btn success" onclick="setDebugSensorValue()">ğŸ“¤ æ¨¡æ‹Ÿä¸ŠæŠ¥</button>
                        <button class="quick-value-btn" onclick="setDebugSensorQuick('airTemp', 35)">ğŸŒ¡ï¸ 35Â°C</button>
                        <button class="quick-value-btn" onclick="setDebugSensorQuick('airTemp', 5)">â„ï¸ 5Â°C</button>
                        <button class="quick-value-btn" onclick="setDebugSensorQuick('airHum', 90)">ğŸ’§ 90%æ¹¿åº¦</button>
                        <button class="quick-value-btn" onclick="setDebugSensorQuick('light', 50000)">â˜€ï¸ å¼ºå…‰</button>
                    </div>
                    
                    <div class="debug-output" id="sensorDebugOutput">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
            
            <!-- è‡ªå®šä¹‰RPCè°ƒç”¨ -->
            <div class="debug-card rpc-debug">
                <div class="debug-card-header">
                    ğŸ› ï¸ è‡ªå®šä¹‰RPCè°ƒç”¨
                </div>
                <div class="debug-card-body">
                    <div class="debug-form-group">
                        <label>RPCæ–¹æ³•å</label>
                        <input type="text" id="rpcMethodName" placeholder="å¦‚: rpc.ping, relay.control">
                    </div>
                    <div class="debug-form-group">
                        <label>å‚æ•° (JSON)</label>
                        <textarea id="rpcMethodParams" placeholder='{"node": 1, "ch": 0, "action": "fwd"}'>{}</textarea>
                    </div>
                    
                    <div style="margin: 10px 0; font-size: 12px; color: #666;">
                        <strong>å¸¸ç”¨æ–¹æ³•:</strong> rpc.ping, sys.info, can.status, relay.control, relay.statusAll, group.list, group.control, config.get, config.save
                    </div>
                    
                    <div class="debug-btn-group">
                        <button class="debug-btn success" onclick="callCustomRpc()">ğŸš€ å‘é€è¯·æ±‚</button>
                        <button class="debug-btn primary" onclick="callRpcQuick('rpc.ping', {})">ğŸ”” Ping</button>
                        <button class="debug-btn primary" onclick="callRpcQuick('sys.info', {})">â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</button>
                        <button class="debug-btn warning" onclick="callRpcQuick('can.status', {})">ğŸ”§ CANçŠ¶æ€</button>
                    </div>
                    
                    <div class="debug-output" id="rpcDebugOutput">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿè¯Šæ–­ -->
            <div class="debug-card system-debug">
                <div class="debug-card-header">
                    âš™ï¸ ç³»ç»Ÿè¯Šæ–­
                </div>
                <div class="debug-card-body">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">RPCè¿æ¥</div>
                            <div style="font-size: 16px; font-weight: 600;" id="diagRpcStatus">--</div>
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">CANæ€»çº¿</div>
                            <div style="font-size: 16px; font-weight: 600;" id="diagCanStatus">--</div>
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">è®¾å¤‡æ•°é‡</div>
                            <div style="font-size: 16px; font-weight: 600;" id="diagDeviceCount">--</div>
                        </div>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">MQTTé€šé“</div>
                            <div style="font-size: 16px; font-weight: 600;" id="diagMqttCount">--</div>
                        </div>
                    </div>
                    
                    <div class="debug-btn-group">
                        <button class="debug-btn primary" onclick="runDiagnostics()">ğŸ” è¿è¡Œè¯Šæ–­</button>
                        <button class="debug-btn success" onclick="callRpcQuick('sys.info', {})">â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</button>
                        <button class="debug-btn warning" onclick="callRpcQuick('can.status', {})">ğŸ”§ CANè¯Šæ–­</button>
                    </div>
                    
                    <div class="debug-output" id="systemDebugOutput">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
            
            <!-- æ—¥å¿—æŸ¥çœ‹ -->
            <div class="debug-card log-debug">
                <div class="debug-card-header">
                    ğŸ“‹ å®æ—¶æ—¥å¿—
                </div>
                <div class="debug-card-body">
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <select id="logLevelFilter" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="info">INFO</option>
                            <option value="warn">WARN</option>
                            <option value="error">ERROR</option>
                        </select>
                        <button class="debug-btn" onclick="clearDebugLogs()">ğŸ—‘ï¸ æ¸…ç©º</button>
                        <button class="debug-btn primary" onclick="exportDebugLogs()">ğŸ“¥ å¯¼å‡º</button>
                    </div>
                    
                    <div class="debug-output" id="logDebugOutput" style="max-height: 250px;">ç­‰å¾…æ—¥å¿—...</div>
                </div>
            </div>
            
            <!-- MQTTè°ƒè¯• -->
            <div class="debug-card mqtt-debug">
                <div class="debug-card-header">
                    â˜ï¸ MQTTè°ƒè¯•
                </div>
                <div class="debug-card-body">
                    <div class="debug-form-row">
                        <div class="debug-form-group">
                            <label>é€šé“ID</label>
                            <input type="number" id="mqttDebugChannelId" value="1" min="1">
                        </div>
                        <div class="debug-form-group">
                            <label>ä¸»é¢˜</label>
                            <input type="text" id="mqttDebugTopic" placeholder="test/topic">
                        </div>
                        <div class="debug-form-group">
                            <label>QoS</label>
                            <select id="mqttDebugQos">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="debug-form-group">
                        <label>æ¶ˆæ¯å†…å®¹ (JSON)</label>
                        <textarea id="mqttDebugPayload" placeholder='{"message": "Hello"}'>{}</textarea>
                    </div>
                    
                    <div class="debug-btn-group">
                        <button class="debug-btn success" onclick="mqttPublishDebug()">ğŸ“¤ å‘å¸ƒæ¶ˆæ¯</button>
                        <button class="debug-btn primary" onclick="mqttSubscribeDebug()">ğŸ“¥ è®¢é˜…ä¸»é¢˜</button>
                        <button class="debug-btn warning" onclick="listMqttChannels()">ğŸ“‹ æŸ¥çœ‹é€šé“</button>
                    </div>
                    
                    <div class="debug-output" id="mqttDebugOutput">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
            
            <!-- é…ç½®è°ƒè¯• -->
            <div class="debug-card config-debug">
                <div class="debug-card-header">
                    ğŸ’¾ é…ç½®ç®¡ç†
                </div>
                <div class="debug-card-body">
                    <div class="debug-form-group">
                        <label>é…ç½®è·¯å¾„ (å¯é€‰)</label>
                        <input type="text" id="configPath" placeholder="å¦‚: main.rpcPort æˆ–ç•™ç©ºè·å–å…¨éƒ¨">
                    </div>
                    
                    <div class="debug-btn-group">
                        <button class="debug-btn primary" onclick="getConfigDebug()">ğŸ“– è¯»å–é…ç½®</button>
                        <button class="debug-btn success" onclick="saveConfigDebug()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                        <button class="debug-btn warning" onclick="reloadConfigDebug()">ğŸ”„ é‡è½½é…ç½®</button>
                    </div>
                    
                    <div class="debug-output" id="configDebugOutput" style="max-height: 300px;">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
            
            <!-- åœºæ™¯è§¦å‘æµ‹è¯• -->
            <div class="debug-card sensor-debug">
                <div class="debug-card-header">
                    âš¡ åœºæ™¯è§¦å‘æµ‹è¯•
                </div>
                <div class="debug-card-body">
                    <div class="debug-form-row">
                        <div class="debug-form-group">
                            <label>åœºæ™¯ID</label>
                            <input type="number" id="testSceneId" value="1" min="1">
                        </div>
                        <div class="debug-form-group">
                            <label>åœºæ™¯ç±»å‹</label>
                            <select id="testSceneType">
                                <option value="auto">è‡ªåŠ¨åœºæ™¯</option>
                                <option value="manual">æ‰‹åŠ¨åœºæ™¯</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="debug-btn-group">
                        <button class="debug-btn success" onclick="testSceneTrigger()">âš¡ è§¦å‘åœºæ™¯</button>
                        <button class="debug-btn primary" onclick="listScenes()">ğŸ“‹ åœºæ™¯åˆ—è¡¨</button>
                        <button class="debug-btn warning" onclick="checkSceneStatus()">ğŸ” çŠ¶æ€æ£€æŸ¥</button>
                    </div>
                    
                    <div class="debug-output" id="sceneDebugOutput">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
            
            <!-- ç»§ç”µå™¨ç›´æ¥æ§åˆ¶ -->
            <div class="debug-card rpc-debug">
                <div class="debug-card-header">
                    ğŸ›ï¸ ç»§ç”µå™¨ç›´æ¥æ§åˆ¶
                </div>
                <div class="debug-card-body">
                    <div class="debug-form-row">
                        <div class="debug-form-group">
                            <label>èŠ‚ç‚¹ID</label>
                            <input type="number" id="relayNode" value="1" min="1" max="255">
                        </div>
                        <div class="debug-form-group">
                            <label>é€šé“</label>
                            <select id="relayChannel">
                                <option value="0">CH0</option>
                                <option value="1">CH1</option>
                                <option value="2">CH2</option>
                                <option value="3">CH3</option>
                            </select>
                        </div>
                        <div class="debug-form-group">
                            <label>åŠ¨ä½œ</label>
                            <select id="relayAction">
                                <option value="stop">â¹ï¸ åœæ­¢</option>
                                <option value="fwd">â–¶ï¸ æ­£è½¬</option>
                                <option value="rev">â—€ï¸ åè½¬</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="debug-btn-group">
                        <button class="debug-btn success" onclick="controlRelayDebug()">âš¡ æ‰§è¡Œ</button>
                        <button class="debug-btn primary" onclick="queryRelayDebug()">ğŸ” æŸ¥è¯¢çŠ¶æ€</button>
                        <button class="debug-btn warning" onclick="queryAllRelaysDebug()">ğŸ“Š å…¨éƒ¨çŠ¶æ€</button>
                    </div>
                    
                    <div class="debug-output" id="relayDebugOutput">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // WebSocketè¿æ¥
        let ws = null;
        let requestId = 1;
        let pendingRequests = {};
        let debugLogs = [];
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä»sessionStorageè¯»å–è¿æ¥ä¿¡æ¯
            const host = sessionStorage.getItem('rpc_host');
            const rpcPort = sessionStorage.getItem('rpc_port');
            const wsPort = sessionStorage.getItem('ws_port');
            
            if (host) document.getElementById('serverHost').value = host;
            if (rpcPort) document.getElementById('rpcPort').value = rpcPort;
            if (wsPort) document.getElementById('wsPort').value = wsPort;
            
            // æ£€æµ‹Tauriç¯å¢ƒ
            if (window.__TAURI__) {
                document.getElementById('websocatToggleBtn').style.display = 'inline-block';
            }
            
            addDebugLog('info', 'å¼€å‘è€…è°ƒè¯•å·¥å…·å·²åŠ è½½');
        });
        
        // è¿æ¥ç®¡ç†
        function toggleConnection() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            } else {
                connect();
            }
        }
        
        function connect() {
            const host = document.getElementById('serverHost').value.trim() || 'localhost';
            const wsPort = document.getElementById('wsPort').value || 12346;
            
            const url = `ws://${host}:${wsPort}`;
            addDebugLog('info', `æ­£åœ¨è¿æ¥ ${url}...`);
            
            ws = new WebSocket(url);
            
            ws.onopen = function() {
                updateConnectionStatus(true);
                addDebugLog('success', 'âœ… WebSocketè¿æ¥æˆåŠŸ');
                runDiagnostics();
            };
            
            ws.onclose = function() {
                updateConnectionStatus(false);
                addDebugLog('warn', 'âš ï¸ WebSocketè¿æ¥å·²æ–­å¼€');
            };
            
            ws.onerror = function(err) {
                updateConnectionStatus(false);
                addDebugLog('error', 'âŒ WebSocketè¿æ¥é”™è¯¯');
            };
            
            ws.onmessage = function(event) {
                handleMessage(event.data);
            };
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            
            if (connected) {
                statusEl.className = 'debug-status connected';
                statusEl.innerHTML = '<span>â—</span><span>å·²è¿æ¥</span>';
                connectBtn.textContent = 'ğŸ”Œ æ–­å¼€';
                document.getElementById('diagRpcStatus').textContent = 'âœ… å·²è¿æ¥';
                document.getElementById('diagRpcStatus').style.color = '#2e7d32';
            } else {
                statusEl.className = 'debug-status disconnected';
                statusEl.innerHTML = '<span>â—</span><span>æœªè¿æ¥</span>';
                connectBtn.textContent = 'ğŸ”Œ è¿æ¥';
                document.getElementById('diagRpcStatus').textContent = 'âŒ æœªè¿æ¥';
                document.getElementById('diagRpcStatus').style.color = '#c62828';
            }
        }
        
        // RPCè°ƒç”¨
        function callMethod(method, params, callback) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addDebugLog('error', 'è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨');
                return;
            }
            
            const id = requestId++;
            const request = {
                jsonrpc: '2.0',
                id: id,
                method: method,
                params: params
            };
            
            pendingRequests[id] = callback;
            ws.send(JSON.stringify(request));
            addDebugLog('info', `ğŸ“¤ å‘é€: ${method}`);
        }
        
        function handleMessage(data) {
            try {
                const response = JSON.parse(data);
                addDebugLog('info', `ğŸ“¥ æ”¶åˆ°å“åº”: ${JSON.stringify(response).substring(0, 100)}...`);
                
                if (response.id && pendingRequests[response.id]) {
                    pendingRequests[response.id](response);
                    delete pendingRequests[response.id];
                }
            } catch (e) {
                addDebugLog('error', `è§£æå“åº”å¤±è´¥: ${e.message}`);
            }
        }
        
        // æ—¥å¿—ç®¡ç†
        function addDebugLog(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const log = { timestamp, level, message };
            debugLogs.push(log);
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (debugLogs.length > 500) {
                debugLogs = debugLogs.slice(-400);
            }
            
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const container = document.getElementById('logDebugOutput');
            const filter = document.getElementById('logLevelFilter').value;
            
            let filtered = debugLogs;
            if (filter !== 'all') {
                filtered = debugLogs.filter(l => l.level === filter);
            }
            
            const html = filtered.slice(-50).map(log => {
                let color = '#d4d4d4';
                if (log.level === 'error') color = '#f44336';
                else if (log.level === 'warn') color = '#ff9800';
                else if (log.level === 'success') color = '#4caf50';
                
                return `<div style="color: ${color}; margin-bottom: 4px;">[${log.timestamp}] ${log.message}</div>`;
            }).join('');
            
            container.innerHTML = html || 'æš‚æ— æ—¥å¿—';
            container.scrollTop = container.scrollHeight;
        }
        
        function clearDebugLogs() {
            debugLogs = [];
            updateLogDisplay();
            addDebugLog('info', 'æ—¥å¿—å·²æ¸…ç©º');
        }
        
        function exportDebugLogs() {
            const content = debugLogs.map(l => `[${l.timestamp}] [${l.level.toUpperCase()}] ${l.message}`).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug_logs_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addDebugLog('info', 'æ—¥å¿—å·²å¯¼å‡º');
        }
        
        // ä¼ æ„Ÿå™¨è°ƒè¯•
        function setDebugSensorValue() {
            const deviceCode = document.getElementById('debugDeviceCode').value;
            const identifier = document.getElementById('debugIdentifier').value;
            const value = parseFloat(document.getElementById('debugIdentifierValue').value);
            
            callMethod('sensor.debug.set', {
                deviceCode: deviceCode,
                identifier: identifier,
                value: value
            }, function(response) {
                const output = document.getElementById('sensorDebugOutput');
                if (response.result) {
                    output.innerHTML = `<span style="color: #4caf50;">âœ… æ¨¡æ‹Ÿæ•°æ®å·²å‘é€</span>\n${JSON.stringify(response.result, null, 2)}`;
                } else if (response.error) {
                    output.innerHTML = `<span style="color: #f44336;">âŒ é”™è¯¯: ${response.error.message}</span>`;
                }
            });
        }
        
        function setDebugSensorQuick(identifier, value) {
            document.getElementById('debugIdentifier').value = identifier;
            document.getElementById('debugIdentifierValue').value = value;
            setDebugSensorValue();
        }
        
        // RPCè°ƒè¯•
        function callCustomRpc() {
            const method = document.getElementById('rpcMethodName').value.trim();
            const paramsStr = document.getElementById('rpcMethodParams').value;
            
            if (!method) {
                addDebugLog('error', 'è¯·è¾“å…¥æ–¹æ³•å');
                return;
            }
            
            let params = {};
            try {
                params = JSON.parse(paramsStr);
            } catch (e) {
                addDebugLog('error', 'JSONå‚æ•°æ ¼å¼é”™è¯¯');
                return;
            }
            
            callMethod(method, params, function(response) {
                const output = document.getElementById('rpcDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        function callRpcQuick(method, params) {
            callMethod(method, params, function(response) {
                const output = document.getElementById('rpcDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        // ç³»ç»Ÿè¯Šæ–­
        function runDiagnostics() {
            addDebugLog('info', 'æ­£åœ¨è¿è¡Œè¯Šæ–­...');
            
            // è·å–ç³»ç»Ÿä¿¡æ¯
            callMethod('sys.info', {}, function(response) {
                const output = document.getElementById('systemDebugOutput');
                if (response.result) {
                    output.innerHTML = JSON.stringify(response.result, null, 2);
                }
            });
            
            // è·å–CANçŠ¶æ€
            callMethod('can.status', {}, function(response) {
                const diagCan = document.getElementById('diagCanStatus');
                if (response.result && response.result.open) {
                    diagCan.textContent = 'âœ… æ­£å¸¸';
                    diagCan.style.color = '#2e7d32';
                } else {
                    diagCan.textContent = 'âŒ æœªæ‰“å¼€';
                    diagCan.style.color = '#c62828';
                }
            });
            
            // è·å–è®¾å¤‡åˆ—è¡¨
            callMethod('device.list', {}, function(response) {
                const diagDevice = document.getElementById('diagDeviceCount');
                if (response.result && response.result.devices) {
                    diagDevice.textContent = response.result.devices.length;
                    diagDevice.style.color = '#333';
                }
            });
            
            // è·å–MQTTé€šé“
            callMethod('mqtt.channels.list', {}, function(response) {
                const diagMqtt = document.getElementById('diagMqttCount');
                if (response.result && response.result.channels) {
                    const connected = response.result.channels.filter(c => c.connected).length;
                    const total = response.result.channels.length;
                    diagMqtt.textContent = `${connected}/${total}`;
                    diagMqtt.style.color = connected > 0 ? '#2e7d32' : '#666';
                }
            });
        }
        
        // MQTTè°ƒè¯•
        function mqttPublishDebug() {
            const channelId = parseInt(document.getElementById('mqttDebugChannelId').value);
            const topic = document.getElementById('mqttDebugTopic').value;
            const qos = parseInt(document.getElementById('mqttDebugQos').value);
            const payload = document.getElementById('mqttDebugPayload').value;
            
            callMethod('mqtt.publish', {
                channelId: channelId,
                topic: topic,
                payload: payload,
                qos: qos
            }, function(response) {
                const output = document.getElementById('mqttDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        function mqttSubscribeDebug() {
            const channelId = parseInt(document.getElementById('mqttDebugChannelId').value);
            const topic = document.getElementById('mqttDebugTopic').value;
            const qos = parseInt(document.getElementById('mqttDebugQos').value);
            
            callMethod('mqtt.subscribe', {
                channelId: channelId,
                topic: topic,
                qos: qos
            }, function(response) {
                const output = document.getElementById('mqttDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        function listMqttChannels() {
            callMethod('mqtt.channels.list', {}, function(response) {
                const output = document.getElementById('mqttDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        // é…ç½®è°ƒè¯•
        function getConfigDebug() {
            const path = document.getElementById('configPath').value.trim();
            
            callMethod('config.get', path ? { path: path } : {}, function(response) {
                const output = document.getElementById('configDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        function saveConfigDebug() {
            callMethod('config.save', {}, function(response) {
                const output = document.getElementById('configDebugOutput');
                if (response.result && response.result.ok) {
                    output.innerHTML = '<span style="color: #4caf50;">âœ… é…ç½®å·²ä¿å­˜</span>';
                } else {
                    output.innerHTML = JSON.stringify(response, null, 2);
                }
            });
        }
        
        function reloadConfigDebug() {
            callMethod('config.reload', {}, function(response) {
                const output = document.getElementById('configDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        // åœºæ™¯æµ‹è¯•
        function testSceneTrigger() {
            const sceneId = parseInt(document.getElementById('testSceneId').value);
            const sceneType = document.getElementById('testSceneType').value;
            
            callMethod('scene.trigger', {
                sceneId: sceneId,
                type: sceneType
            }, function(response) {
                const output = document.getElementById('sceneDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        function listScenes() {
            callMethod('scene.list', {}, function(response) {
                const output = document.getElementById('sceneDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        function checkSceneStatus() {
            callMethod('scene.status', {}, function(response) {
                const output = document.getElementById('sceneDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        // ç»§ç”µå™¨æ§åˆ¶
        function controlRelayDebug() {
            const node = parseInt(document.getElementById('relayNode').value);
            const ch = parseInt(document.getElementById('relayChannel').value);
            const action = document.getElementById('relayAction').value;
            
            callMethod('relay.control', {
                node: node,
                ch: ch,
                action: action
            }, function(response) {
                const output = document.getElementById('relayDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        function queryRelayDebug() {
            const node = parseInt(document.getElementById('relayNode').value);
            
            callMethod('relay.statusAll', { node: node }, function(response) {
                const output = document.getElementById('relayDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        function queryAllRelaysDebug() {
            callMethod('relay.queryAll', {}, function(response) {
                const output = document.getElementById('relayDebugOutput');
                output.innerHTML = JSON.stringify(response, null, 2);
            });
        }
        
        // Tauriä»£ç†æ§åˆ¶
        async function toggleWebsocatProxy() {
            if (!window.__TAURI__) return;
            
            // è¿™é‡Œéœ€è¦è°ƒç”¨Tauriçš„å‘½ä»¤æ¥å¯åŠ¨/åœæ­¢ä»£ç†
            addDebugLog('info', 'æ­£åœ¨åˆ‡æ¢ä»£ç†çŠ¶æ€...');
            // å®é™…å®ç°éœ€è¦æ ¹æ®Tauriåç«¯çš„APIæ¥å®Œæˆ
        }
        
        // æ—¥å¿—çº§åˆ«è¿‡æ»¤å™¨å˜åŒ–æ—¶æ›´æ–°æ˜¾ç¤º
        document.getElementById('logLevelFilter')?.addEventListener('change', updateLogDisplay);
    </script>
</body>
</html>
