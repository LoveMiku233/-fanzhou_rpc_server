<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³›èˆŸRPCæœåŠ¡å™¨è°ƒè¯•å·¥å…·</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #444;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            height: 100px;
            font-family: monospace;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.secondary {
            background-color: #6c757d;
        }
        button.secondary:hover {
            background-color: #545b62;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #1e7e34;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        #response {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .connection-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .log-entry {
            border-bottom: 1px solid #eee;
            padding: 5px 0;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-time {
            color: #888;
            font-size: 11px;
        }
        .log-direction {
            font-weight: bold;
        }
        .log-direction.send {
            color: #007bff;
        }
        .log-direction.recv {
            color: #28a745;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .info-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ æ³›èˆŸRPCæœåŠ¡å™¨è°ƒè¯•å·¥å…·</h1>
        <p class="info-text" style="text-align: center; margin-bottom: 20px;">
            ç”¨äºè°ƒè¯•è¿è¡Œåœ¨å…¨å¿—A133å¹³å°ä¸Šçš„JSON-RPCæœåŠ¡å™¨
        </p>
        
        <!-- è¿æ¥è®¾ç½® -->
        <div class="section">
            <h2>ğŸ“¡ è¿æ¥è®¾ç½®</h2>
            <div class="connection-bar">
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <input type="text" id="serverHost" placeholder="æœåŠ¡å™¨åœ°å€" value="localhost">
                </div>
                <div class="form-group" style="width: 100px; margin-bottom: 0;">
                    <input type="number" id="serverPort" placeholder="ç«¯å£" value="12345">
                </div>
                <span class="status disconnected" id="connectionStatus">æœªè¿æ¥</span>
            </div>
            <p class="info-text">
                æ³¨æ„ï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ­¤å·¥å…·ä½¿ç”¨WebSocketæ¨¡æ‹ŸRPCè°ƒç”¨ã€‚
                å®é™…è°ƒè¯•æ—¶éœ€è¦è¿è¡ŒWebSocketä»£ç†æˆ–ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ã€‚
            </p>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="section">
            <div class="tabs">
                <div class="tab active" onclick="showTab('quick')">å¿«æ·æ“ä½œ</div>
                <div class="tab" onclick="showTab('custom')">è‡ªå®šä¹‰è°ƒç”¨</div>
                <div class="tab" onclick="showTab('relay')">ç»§ç”µå™¨æ§åˆ¶</div>
                <div class="tab" onclick="showTab('group')">åˆ†ç»„ç®¡ç†</div>
            </div>

            <!-- å¿«æ·æ“ä½œ -->
            <div class="tab-content active" id="tab-quick">
                <h3 style="margin-bottom: 15px;">å¸¸ç”¨RPCæ–¹æ³•</h3>
                <div class="quick-actions">
                    <button onclick="callMethod('rpc.ping', {})">ğŸ”” Pingæµ‹è¯•</button>
                    <button onclick="callMethod('rpc.list', {})">ğŸ“‹ åˆ—å‡ºæ–¹æ³•</button>
                    <button onclick="callMethod('relay.nodes', {})">ğŸ”Œ è®¾å¤‡åˆ—è¡¨</button>
                    <button onclick="callMethod('group.list', {})">ğŸ“‚ åˆ†ç»„åˆ—è¡¨</button>
                    <button onclick="callMethod('control.queue.status', {})">ğŸ“Š é˜Ÿåˆ—çŠ¶æ€</button>
                    <button onclick="callMethod('auto.strategy.list', {})">âš™ï¸ ç­–ç•¥åˆ—è¡¨</button>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰è°ƒç”¨ -->
            <div class="tab-content" id="tab-custom">
                <div class="form-row">
                    <div class="form-group">
                        <label>æ–¹æ³•å</label>
                        <input type="text" id="methodName" placeholder="ä¾‹å¦‚: rpc.ping">
                    </div>
                </div>
                <div class="form-group">
                    <label>å‚æ•° (JSONæ ¼å¼)</label>
                    <textarea id="methodParams" placeholder='ä¾‹å¦‚: {"node": 1, "ch": 0}'>{}</textarea>
                </div>
                <button onclick="callCustomMethod()">ğŸš€ å‘é€è¯·æ±‚</button>
            </div>

            <!-- ç»§ç”µå™¨æ§åˆ¶ -->
            <div class="tab-content" id="tab-relay">
                <div class="form-row">
                    <div class="form-group">
                        <label>èŠ‚ç‚¹ID</label>
                        <input type="number" id="relayNode" value="1" min="1" max="255">
                    </div>
                    <div class="form-group">
                        <label>é€šé“</label>
                        <select id="relayChannel">
                            <option value="0">é€šé“ 0</option>
                            <option value="1">é€šé“ 1</option>
                            <option value="2">é€šé“ 2</option>
                            <option value="3">é€šé“ 3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åŠ¨ä½œ</label>
                        <select id="relayAction">
                            <option value="stop">åœæ­¢ (Stop)</option>
                            <option value="fwd">æ­£è½¬ (Forward)</option>
                            <option value="rev">åè½¬ (Reverse)</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="success" onclick="controlRelay()">âš¡ æ§åˆ¶ç»§ç”µå™¨</button>
                    <button onclick="queryRelay()">ğŸ” æŸ¥è¯¢çŠ¶æ€</button>
                    <button onclick="queryRelayAll()">ğŸ“Š æŸ¥è¯¢å…¨éƒ¨é€šé“</button>
                </div>
            </div>

            <!-- åˆ†ç»„ç®¡ç† -->
            <div class="tab-content" id="tab-group">
                <div class="form-row">
                    <div class="form-group">
                        <label>åˆ†ç»„ID</label>
                        <input type="number" id="groupId" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>åˆ†ç»„åç§°</label>
                        <input type="text" id="groupName" placeholder="ä¾‹å¦‚: main-group">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>é€šé“</label>
                        <select id="groupChannel">
                            <option value="0">é€šé“ 0</option>
                            <option value="1">é€šé“ 1</option>
                            <option value="2">é€šé“ 2</option>
                            <option value="3">é€šé“ 3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åŠ¨ä½œ</label>
                        <select id="groupAction">
                            <option value="stop">åœæ­¢ (Stop)</option>
                            <option value="fwd">æ­£è½¬ (Forward)</option>
                            <option value="rev">åè½¬ (Reverse)</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="success" onclick="controlGroup()">âš¡ åˆ†ç»„æ§åˆ¶</button>
                    <button onclick="createGroup()">â• åˆ›å»ºåˆ†ç»„</button>
                    <button class="danger" onclick="deleteGroup()">ğŸ—‘ï¸ åˆ é™¤åˆ†ç»„</button>
                </div>
            </div>
        </div>

        <!-- å“åº”ç»“æœ -->
        <div class="section">
            <h2>ğŸ“ é€šä¿¡æ—¥å¿—</h2>
            <button class="secondary" onclick="clearLog()" style="margin-bottom: 10px;">æ¸…ç©ºæ—¥å¿—</button>
            <div id="response">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="section">
            <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
            <div style="color: #666; font-size: 14px;">
                <p><strong>1. å‘½ä»¤è¡Œè°ƒè¯•æ–¹å¼ï¼š</strong></p>
                <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0;">
# ä½¿ç”¨ netcat å‘é€ JSON-RPC è¯·æ±‚
echo '{"jsonrpc":"2.0","id":1,"method":"rpc.ping","params":{}}' | nc localhost 12345

# ä½¿ç”¨ curl + socat æµ‹è¯•
echo '{"jsonrpc":"2.0","id":1,"method":"relay.nodes","params":{}}' | socat - TCP:localhost:12345
                </pre>
                
                <p><strong>2. A133å¹³å°éƒ¨ç½²ï¼š</strong></p>
                <ul style="margin-left: 20px;">
                    <li>ç¡®ä¿CANæ¥å£å·²æ­£ç¡®é…ç½® (can0)</li>
                    <li>æœåŠ¡é»˜è®¤ç›‘å¬ç«¯å£ 12345</li>
                    <li>é…ç½®æ–‡ä»¶ä½äº /var/lib/fanzhou_core/core.json</li>
                    <li>æ—¥å¿—æ–‡ä»¶ä½äº /var/log/fanzhou_core/core.log</li>
                </ul>
                
                <p style="margin-top: 10px;"><strong>3. å¸¸ç”¨RPCæ–¹æ³•ï¼š</strong></p>
                <ul style="margin-left: 20px;">
                    <li><code>rpc.ping</code> - æµ‹è¯•è¿æ¥</li>
                    <li><code>rpc.list</code> - åˆ—å‡ºæ‰€æœ‰RPCæ–¹æ³•</li>
                    <li><code>relay.control</code> - æ§åˆ¶ç»§ç”µå™¨</li>
                    <li><code>relay.nodes</code> - è·å–è®¾å¤‡åˆ—è¡¨</li>
                    <li><code>group.list</code> - è·å–åˆ†ç»„åˆ—è¡¨</li>
                    <li><code>group.control</code> - åˆ†ç»„æ§åˆ¶</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let requestId = 1;
        
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(el => {
                el.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function log(direction, message) {
            const responseEl = document.getElementById('response');
            const time = new Date().toLocaleTimeString();
            const dirClass = direction === '>>>' ? 'send' : 'recv';
            const dirLabel = direction === '>>>' ? 'å‘é€' : 'æ¥æ”¶';
            
            let formattedMessage = message;
            try {
                if (typeof message === 'object') {
                    formattedMessage = JSON.stringify(message, null, 2);
                } else if (typeof message === 'string') {
                    const parsed = JSON.parse(message);
                    formattedMessage = JSON.stringify(parsed, null, 2);
                }
            } catch (e) {
                // ä¿æŒåŸæ ·
            }
            
            const entry = `<div class="log-entry">
                <span class="log-time">[${time}]</span>
                <span class="log-direction ${dirClass}">[${dirLabel}]</span>
                <pre style="margin: 5px 0 0 0; white-space: pre-wrap;">${formattedMessage}</pre>
            </div>`;
            
            responseEl.innerHTML = entry + responseEl.innerHTML;
        }
        
        function clearLog() {
            document.getElementById('response').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º';
        }
        
        function buildRequest(method, params) {
            return {
                jsonrpc: "2.0",
                id: requestId++,
                method: method,
                params: params || {}
            };
        }
        
        function callMethod(method, params) {
            const request = buildRequest(method, params);
            log('>>>', request);
            
            // æ¨¡æ‹Ÿå“åº”ï¼ˆå®é™…ä½¿ç”¨æ—¶éœ€è¦WebSocketä»£ç†ï¼‰
            const host = document.getElementById('serverHost').value.replace(/[^a-zA-Z0-9.-]/g, '');
            const port = parseInt(document.getElementById('serverPort').value) || 12345;
            
            // å®‰å…¨åœ°è½¬ä¹‰JSONå­—ç¬¦ä¸²ç”¨äºshellå‘½ä»¤
            const jsonStr = JSON.stringify(request).replace(/'/g, "'\\''");
            
            log('<<<', {
                info: `è¯·ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·è¿æ¥åˆ° ${host}:${port}`,
                command: `echo '${jsonStr}' | nc ${host} ${port}`
            });
        }
        
        function callCustomMethod() {
            const method = document.getElementById('methodName').value;
            const paramsStr = document.getElementById('methodParams').value;
            
            if (!method) {
                alert('è¯·è¾“å…¥æ–¹æ³•å');
                return;
            }
            
            let params = {};
            try {
                params = JSON.parse(paramsStr);
            } catch (e) {
                alert('å‚æ•°æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON');
                return;
            }
            
            callMethod(method, params);
        }
        
        function controlRelay() {
            const node = parseInt(document.getElementById('relayNode').value);
            const ch = parseInt(document.getElementById('relayChannel').value);
            const action = document.getElementById('relayAction').value;
            
            callMethod('relay.control', {
                node: node,
                ch: ch,
                action: action
            });
        }
        
        function queryRelay() {
            const node = parseInt(document.getElementById('relayNode').value);
            const ch = parseInt(document.getElementById('relayChannel').value);
            
            callMethod('relay.status', {
                node: node,
                ch: ch
            });
        }
        
        function queryRelayAll() {
            const node = parseInt(document.getElementById('relayNode').value);
            
            callMethod('relay.statusAll', {
                node: node
            });
        }
        
        function controlGroup() {
            const groupId = parseInt(document.getElementById('groupId').value);
            const ch = parseInt(document.getElementById('groupChannel').value);
            const action = document.getElementById('groupAction').value;
            
            callMethod('group.control', {
                groupId: groupId,
                ch: ch,
                action: action
            });
        }
        
        function createGroup() {
            const groupId = parseInt(document.getElementById('groupId').value);
            const name = document.getElementById('groupName').value;
            
            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                return;
            }
            
            callMethod('group.create', {
                groupId: groupId,
                name: name
            });
        }
        
        function deleteGroup() {
            const groupId = parseInt(document.getElementById('groupId').value);
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„ ${groupId} å—ï¼Ÿ`)) {
                callMethod('group.delete', {
                    groupId: groupId
                });
            }
        }
    </script>
</body>
</html>
