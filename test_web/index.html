<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>泛舟RPC服务器调试工具</title>
    <!-- ========================================================
         泛舟RPC服务器调试工具
         
         功能说明：
         1. 通过WebSocket连接到RPC服务器（需要websocket代理）
         2. 提供快捷操作按钮用于常用RPC方法
         3. 支持继电器控制和分组管理
         4. 提供设备列表和分组列表的可视化显示
         5. 左右布局：导航在左侧，内容在右侧
         6. 动态背景动画效果
         
         使用方法：
         1. 在设备上启动websocat代理：
            websocat --text ws-l:0.0.0.0:12346 tcp:127.0.0.1:12345
         2. 在浏览器中打开此页面
         3. 输入设备IP地址和WebSocket端口，点击连接
         
         RPC说明：
         - relay.control: 控制单个节点的单个通道
         - group.control: 控制分组中所有节点的指定通道
         ======================================================== -->
    <!-- 引入外部样式表 -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/blueprint.css">
</head>
<body>
    <!-- ==================== 动态背景动画 ==================== -->
    <div class="animated-background"></div>
    <div class="floating-shapes">
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>

    <!-- ==================== 页面头部 ==================== -->
    <div class="header">
        <h1>🚀 泛舟RPC服务器调试工具</h1>
        <div class="header-status">
            <span class="status-badge disconnected" id="headerConnectionStatus">
                <span class="status-dot"></span>
                <span>未连接</span>
            </span>
        </div>
    </div>

    <!-- ==================== 主布局容器 - 左右布局 ==================== -->
    <div class="main-layout">
        <!-- ==================== 左侧导航栏 ==================== -->
        <div class="sidebar">
            <div class="sidebar-nav">
                <button class="nav-btn" onclick="showPage('connection')" data-page="connection">
                    📡 连接
                </button>
                <button class="nav-btn active" onclick="showPage('quick')" data-page="quick">
                    🏠 主页
                </button>
                <button class="nav-btn" onclick="showPage('devices')" data-page="devices">
                    🔌 设备
                </button>
                <button class="nav-btn" onclick="showPage('groups')" data-page="groups">
                    📂 分组
                </button>
                <button class="nav-btn" onclick="showPage('strategy')" data-page="strategy">
                    ⏱️ 策略
                </button>
                <button class="nav-btn" onclick="showPage('blueprint')" data-page="blueprint">
                    🎨 蓝图
                </button>
                <button class="nav-btn" onclick="showPage('custom')" data-page="custom">
                    🛠️ 高级
                </button>
            </div>
        </div>

        <!-- ==================== 右侧内容区 ==================== -->
        <div class="content-area">
            <div class="card">

            <!-- ==================== 连接设置页面 ==================== -->
            <div class="page-content" id="page-connection">
                <h3 style="margin-bottom: 20px; color: #333;">📡 连接设置</h3>
                
                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                    <div class="form-row">
                        <!-- 服务器地址输入 -->
                        <div class="form-group">
                            <label>服务器地址</label>
                            <input type="text" id="serverHost" placeholder="例如: 192.168.1.100" value="localhost">
                        </div>
                        <!-- WebSocket端口输入 -->
                        <div class="form-group">
                            <label>WebSocket端口</label>
                            <input type="number" id="serverPort" placeholder="端口" value="12346">
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                        <!-- 连接/断开按钮 -->
                        <button id="connectBtn" onclick="toggleConnection()" style="min-width: 150px;">🔌 连接</button>
                        <!-- 连接状态显示 -->
                        <span class="status-badge disconnected" id="connectionStatus">
                            <span class="status-dot"></span>
                            <span>未连接</span>
                        </span>
                    </div>
                </div>
                
                <!-- 连接说明 -->
                <div class="help-section">
                    <h4>📋 连接说明</h4>
                    <p style="margin-bottom: 10px; color: #666;">由于浏览器安全限制，需要在设备上运行WebSocket代理。请执行以下命令：</p>
                    <pre>
# 安装websocat（如果尚未安装）
# 下载地址: https://github.com/vi/websocat/releases

# 启动WebSocket到TCP的代理（文本模式）
websocat --text ws-l:0.0.0.0:12346 tcp:127.0.0.1:12345</pre>
                </div>
                
                <!-- 快速提示 -->
                <div style="background: #e3f2fd; padding: 15px 20px; border-radius: 12px; margin-top: 20px; border-left: 4px solid #2196f3;">
                    <strong style="color: #1565c0;">💡 提示</strong>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;">连接成功后，请切换到"主页"标签页开始使用各项功能。</p>
                </div>
            </div>

            <!-- ==================== 快捷操作页面 ==================== -->
            <div class="page-content active" id="page-quick">
                <h3 style="margin-bottom: 20px; color: #333;">常用RPC方法快捷按钮</h3>
                
                <!-- 快速状态卡片 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 24px; margin-bottom: 8px;">🔌</div>
                        <div style="font-size: 13px; opacity: 0.9;">设备管理</div>
                        <button onclick="showPage('devices'); refreshDeviceList()" style="margin-top: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); width: 100%;">打开</button>
                    </div>
                    <div style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 24px; margin-bottom: 8px;">📂</div>
                        <div style="font-size: 13px; opacity: 0.9;">分组控制</div>
                        <button onclick="showPage('groups'); refreshGroupList()" style="margin-top: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); width: 100%;">打开</button>
                    </div>
                    <div style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 24px; margin-bottom: 8px;">⏱️</div>
                        <div style="font-size: 13px; opacity: 0.9;">自动策略</div>
                        <button onclick="showPage('strategy'); refreshStrategyList()" style="margin-top: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); width: 100%;">打开</button>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 12px; color: white;">
                        <div style="font-size: 24px; margin-bottom: 8px;">🎨</div>
                        <div style="font-size: 13px; opacity: 0.9;">可视化蓝图</div>
                        <button onclick="showPage('blueprint')" style="margin-top: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); width: 100%;">打开</button>
                    </div>
                </div>

                <!-- 配置保存提示 -->
                <div style="background: #e8f5e9; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <strong style="color: #2e7d32;">💡 修改后别忘了保存配置！</strong>
                            <span style="color: #666; font-size: 13px; margin-left: 10px;">否则重启后会丢失</span>
                        </div>
                        <button class="success" onclick="saveConfig()" style="min-width: 120px;">💾 保存配置</button>
                    </div>
                </div>
                
                <!-- 快捷操作按钮 -->
                <h4 style="margin-bottom: 15px; color: #333;">🚀 快捷操作</h4>
                <div class="quick-actions-grid">
                    <button class="quick-action-btn" onclick="callMethod('rpc.ping', {})">
                        <span class="icon">🔔</span>
                        Ping测试
                    </button>
                    <button class="quick-action-btn" onclick="callMethod('sys.info', {})">
                        <span class="icon">ℹ️</span>
                        系统信息
                    </button>
                    <button class="quick-action-btn warning" onclick="checkCanStatus()">
                        <span class="icon">🔧</span>
                        CAN诊断
                    </button>
                    <button class="quick-action-btn success" onclick="callMethod('relay.queryAll', {})">
                        <span class="icon">🔍</span>
                        查询全部设备
                    </button>
                </div>
            </div>

            <!-- ==================== 设备列表页面 ==================== -->
            <!-- 
                设备列表页面说明：
                - 显示所有已配置的CAN继电器设备
                - 每个设备以卡片形式展示，包含状态和控制按钮
                - 支持单通道控制和全部通道控制
                - 设备在线状态由服务端根据最后响应时间判断（30秒内有响应认为在线）
            -->
            <div class="page-content" id="page-devices">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">🔌 设备列表</h3>
                    <div class="btn-group">
                        <button onclick="refreshDeviceList()">🔄 刷新列表</button>
                        <button class="secondary" onclick="readDeviceConfig()">📋 读取配置</button>
                        <button class="warning" onclick="checkCanStatus()">🔧 CAN诊断</button>
                    </div>
                </div>
                
                <!-- CAN状态警告提示（当CAN未打开时显示） -->
                <div id="canWarningPanel" style="display: none; background: #fff3e0; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                    <h4 style="margin-bottom: 10px; color: #e65100;">⚠️ CAN总线未打开</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                        控制命令无法发送！CAN总线未正确连接或配置。
                    </p>
                    <div class="btn-group">
                        <button class="warning" onclick="checkCanStatus()">🔧 查看诊断信息</button>
                    </div>
                </div>
                
                <!-- 设备配置显示区域 -->
                <div id="deviceConfigPanel" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">📋 设备配置信息</h4>
                    <pre id="deviceConfigContent" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 13px;"></pre>
                </div>
                
                <!-- 设备卡片网格视图 - 整合了列表和卡片功能 -->
                <!-- 每个卡片既显示设备状态，也提供控制按钮 -->
                <div id="deviceListEmpty" class="data-list-empty" style="display: none; background: #f8f9fa; border-radius: 12px; padding: 40px 20px;">
                    <p>📭 暂无设备数据</p>
                    <p style="font-size: 12px; margin-top: 10px;">请先连接服务器并点击"刷新列表"</p>
                </div>
                <div class="device-cards" id="deviceCards">
                    <!-- 设备卡片将由JavaScript动态生成 -->
                </div>
            </div>

            <!-- ==================== 分组管理页面 ==================== -->
            <div class="page-content" id="page-groups">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">分组管理</h3>
                    <button onclick="refreshGroupList()">🔄 刷新列表</button>
                </div>
                
                <!-- 创建分组表单 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">➕ 创建新分组</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>分组ID</label>
                            <input type="number" id="newGroupId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>分组名称</label>
                            <input type="text" id="newGroupName" placeholder="例如: main-group">
                        </div>
                    </div>
                    <button class="success" onclick="createGroup()">➕ 创建分组</button>
                </div>

                <!-- 添加设备到分组 -->
                <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">🔗 添加设备到分组</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>分组ID</label>
                            <input type="number" id="addDeviceGroupId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>设备节点ID</label>
                            <input type="number" id="addDeviceNodeId" value="1" min="1" max="255">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="success" onclick="addDeviceToGroup()">➕ 添加设备</button>
                        <button class="danger" onclick="removeDeviceFromGroup()">➖ 移除设备</button>
                    </div>
                </div>

                <!-- 分组列表 -->
                <div class="data-list" id="groupList">
                    <div class="data-list-header">
                        <span>分组信息</span>
                        <span>操作</span>
                    </div>
                    <div class="data-list-empty" id="groupListEmpty">
                        <p>暂无分组数据</p>
                        <p style="font-size: 12px; margin-top: 10px;">请先连接服务器并点击"刷新列表"</p>
                    </div>
                    <div id="groupListContent"></div>
                </div>
            </div>

            <!-- ==================== 策略管理页面 ==================== -->
            <div class="page-content" id="page-strategy">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">⏱️ 策略管理</h3>
                    <div class="btn-group">
                        <button onclick="refreshStrategyList()">🔄 刷新</button>
                        <button class="secondary" onclick="showPage('blueprint')">🎨 可视化编辑器</button>
                    </div>
                </div>

                <!-- 简化提示 -->
                <div style="background: #e3f2fd; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <span style="font-size: 24px;">💡</span>
                        <div>
                            <strong style="color: #1565c0;">推荐使用蓝图编辑器</strong>
                            <p style="color: #666; font-size: 13px; margin: 5px 0 0;">通过拖放方式可视化创建策略，更加直观易用！</p>
                        </div>
                        <button class="success" onclick="showPage('blueprint')" style="margin-left: auto;">🎨 打开蓝图编辑器</button>
                    </div>
                </div>

                <!-- 快速创建定时策略 - 简化版 -->
                <details style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333; margin-bottom: 15px;">➕ 手动创建定时策略（点击展开）</summary>
                    
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>策略ID <button type="button" onclick="autoFillStrategyId()" style="font-size: 10px; padding: 2px 6px; margin-left: 5px;">🔄 自动</button></label>
                            <input type="number" id="newStrategyId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>策略名称</label>
                            <input type="text" id="newStrategyName" placeholder="例如: 定时通风">
                        </div>
                        <div class="form-group">
                            <label>绑定分组ID</label>
                            <input type="number" id="newStrategyGroupId" value="1" min="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>控制通道</label>
                            <select id="newStrategyChannel">
                                <option value="0">通道 0</option>
                                <option value="1">通道 1</option>
                                <option value="2">通道 2</option>
                                <option value="3">通道 3</option>
                                <option value="-1">全部通道</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>执行动作</label>
                            <select id="newStrategyAction">
                                <option value="stop">⏹️ 停止</option>
                                <option value="fwd">▶️ 正转</option>
                                <option value="rev">◀️ 反转</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>自动启动</label>
                            <select id="newStrategyAutoStart">
                                <option value="true">✅ 是</option>
                                <option value="false">❌ 否</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 时间触发配置 -->
                    <div style="background: #fff; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #e0e0e0;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>触发方式</label>
                                <select id="newStrategyTriggerType" onchange="toggleTimerTypeInputs()">
                                    <option value="interval">⏱️ 间隔执行</option>
                                    <option value="daily">📅 每日定时</option>
                                </select>
                            </div>
                            <div class="form-group" id="intervalInputGroup">
                                <label>执行间隔（秒）</label>
                                <input type="number" id="newStrategyInterval" value="60" min="1">
                            </div>
                            <div class="form-group" id="dailyTimeInputGroup" style="display: none;">
                                <label>每日执行时间</label>
                                <input type="time" id="newStrategyDailyTime" value="08:00">
                            </div>
                        </div>
                    </div>
                    
                    <button class="success" onclick="createTimerStrategy()">➕ 创建策略</button>
                </details>
                
                <!-- 传感器触发策略 - 简化为可折叠 -->
                <details style="background: #fff3e0; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">📡 创建传感器触发策略（点击展开）</summary>
                    
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>策略ID <button type="button" onclick="autoFillSensorStrategyId()" style="font-size: 10px; padding: 2px 6px; margin-left: 5px;">🔄 自动</button></label>
                            <input type="number" id="sensorStrategyId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>策略名称</label>
                            <input type="text" id="sensorStrategyName" placeholder="例如: 高温报警">
                        </div>
                        <div class="form-group">
                            <label>传感器类型</label>
                            <select id="sensorType">
                                <option value="temperature">🌡️ 温度</option>
                                <option value="humidity">💧 湿度</option>
                                <option value="light">💡 光照</option>
                                <option value="soil_moisture">🌱 土壤湿度</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>传感器节点</label>
                            <input type="number" id="sensorNodeId" value="1" min="1" max="255">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>触发条件</label>
                            <select id="sensorCondition">
                                <option value="gt">大于 (>)</option>
                                <option value="lt">小于 (<)</option>
                                <option value="gte">≥</option>
                                <option value="lte">≤</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>阈值</label>
                            <input type="number" id="sensorThreshold" value="25" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>分组ID</label>
                            <input type="number" id="sensorGroupId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>通道</label>
                            <select id="sensorChannel">
                                <option value="0">CH0</option>
                                <option value="1">CH1</option>
                                <option value="2">CH2</option>
                                <option value="3">CH3</option>
                                <option value="-1">全部</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>执行动作</label>
                            <select id="sensorAction">
                                <option value="fwd">▶️ 正转</option>
                                <option value="stop">⏹️ 停止</option>
                                <option value="rev">◀️ 反转</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>冷却时间（秒）</label>
                            <input type="number" id="sensorCooldown" value="60" min="0">
                        </div>
                        <div class="form-group">
                            <label>启用</label>
                            <select id="sensorEnabled">
                                <option value="true">✅ 是</option>
                                <option value="false">❌ 否</option>
                            </select>
                        </div>
                    </div>
                    <button class="success" onclick="createSensorStrategy()">➕ 创建</button>
                </details>

                <!-- 分组程序设置 - 简化为可折叠 -->
                <details style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">🔧 分组通道管理（点击展开）</summary>
                    
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>分组ID</label>
                            <input type="number" id="programGroupId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>设备节点</label>
                            <input type="number" id="programNodeId" value="1" min="1" max="255">
                        </div>
                        <div class="form-group">
                            <label>通道</label>
                            <select id="programChannel">
                                <option value="0">CH0</option>
                                <option value="1">CH1</option>
                                <option value="2">CH2</option>
                                <option value="3">CH3</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="success" onclick="addChannelToGroup()">➕ 添加</button>
                        <button class="danger" onclick="removeChannelFromGroup()">➖ 移除</button>
                        <button onclick="getGroupChannels()">🔍 查看</button>
                    </div>
                </details>

                <!-- 策略列表 -->
                <div class="data-list" id="strategyList">
                    <div class="data-list-header">
                        <span>⏱️ 定时策略列表</span>
                        <span>操作</span>
                    </div>
                    <div class="data-list-empty" id="strategyListEmpty">
                        <p>📭 暂无定时策略</p>
                        <p style="font-size: 12px; margin-top: 10px;">点击上方"刷新"按钮获取策略列表</p>
                    </div>
                    <div id="strategyListContent"></div>
                </div>

                <!-- 传感器策略列表 -->
                <div class="data-list" id="sensorStrategyList" style="margin-top: 20px;">
                    <div class="data-list-header">
                        <span>📡 传感器策略列表</span>
                        <span>操作</span>
                    </div>
                    <div class="data-list-empty" id="sensorStrategyListEmpty">
                        <p>📭 暂无传感器策略</p>
                        <p style="font-size: 12px; margin-top: 10px;">传感器策略可在上方"传感器触发策略"区域创建</p>
                    </div>
                    <div id="sensorStrategyListContent"></div>
                </div>
            </div>

            <!-- ==================== 高级功能页面（合并继电器控制、自定义调用、帮助） ==================== -->
            <div class="page-content" id="page-custom">
                <h3 style="margin-bottom: 20px; color: #333;">🛠️ 高级功能</h3>
                
                <!-- 继电器直接控制 -->
                <details open style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">🎛️ 继电器直接控制</summary>
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>节点ID</label>
                            <input type="number" id="relayNode" value="1" min="1" max="255">
                        </div>
                        <div class="form-group">
                            <label>通道</label>
                            <select id="relayChannel">
                                <option value="0">CH0</option>
                                <option value="1">CH1</option>
                                <option value="2">CH2</option>
                                <option value="3">CH3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>动作</label>
                            <select id="relayAction">
                                <option value="stop">⏹️ 停止</option>
                                <option value="fwd">▶️ 正转</option>
                                <option value="rev">◀️ 反转</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="success" onclick="controlRelay()">⚡ 执行</button>
                        <button onclick="queryRelay()">🔍 查询</button>
                        <button onclick="queryRelayAll()">📊 全部</button>
                    </div>
                    
                    <!-- 分组控制 -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <strong style="display: block; margin-bottom: 10px;">📦 分组控制</strong>
                        <div class="form-row">
                            <div class="form-group">
                                <label>分组ID</label>
                                <input type="number" id="groupControlId" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label>通道</label>
                                <select id="groupControlChannel">
                                    <option value="0">CH0</option>
                                    <option value="1">CH1</option>
                                    <option value="2">CH2</option>
                                    <option value="3">CH3</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>动作</label>
                                <select id="groupControlAction">
                                    <option value="stop">⏹️ 停止</option>
                                    <option value="fwd">▶️ 正转</option>
                                    <option value="rev">◀️ 反转</option>
                                </select>
                            </div>
                        </div>
                        <button class="success" onclick="controlGroup()">⚡ 执行分组控制</button>
                    </div>
                </details>

                <!-- 自定义RPC调用 -->
                <details style="background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">🛠️ 自定义RPC调用</summary>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>方法名</label>
                        <input type="text" id="methodName" placeholder="例如: rpc.ping, relay.control">
                    </div>
                    <div class="form-group">
                        <label>参数 (JSON格式)</label>
                        <textarea id="methodParams" placeholder='例如: {"node": 1, "ch": 0, "action": "fwd"}'>{}</textarea>
                    </div>
                    <button onclick="callCustomMethod()">🚀 发送请求</button>
                </details>

                <!-- 配置管理 -->
                <details style="background: #fff3e0; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">💾 配置管理</summary>
                    <p style="color: #666; font-size: 13px; margin: 15px 0;">
                        通过Web页面创建的修改默认只保存在内存中，重启后会丢失。
                    </p>
                    <div class="btn-group">
                        <button class="success" onclick="saveConfig()">💾 保存配置</button>
                        <button onclick="getConfig()">📋 查看配置</button>
                        <button class="warning" onclick="reloadConfig()">🔄 重载配置</button>
                    </div>
                </details>

                <!-- 常用RPC方法参考 -->
                <details style="background: #f5f5f5; padding: 20px; border-radius: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #333;">📚 常用RPC方法参考</summary>
                    <ul style="margin-top: 15px; color: #666; font-size: 13px; line-height: 1.8;">
                        <li><code>rpc.ping</code> - 测试连接</li>
                        <li><code>sys.info</code> - 系统信息</li>
                        <li><code>can.status</code> - CAN总线状态</li>
                        <li><code>relay.control</code> - 控制继电器 <code>{"node": 1, "ch": 0, "action": "fwd"}</code></li>
                        <li><code>relay.statusAll</code> - 查询设备状态 <code>{"node": 1}</code></li>
                        <li><code>group.list</code> - 分组列表</li>
                        <li><code>group.control</code> - 分组控制 <code>{"groupId": 1, "ch": 0, "action": "stop"}</code></li>
                        <li><code>auto.strategy.list</code> - 策略列表</li>
                        <li><code>config.save</code> - 保存配置</li>
                    </ul>
                </details>
            </div>

            <!-- ==================== 蓝图编辑器页面 ==================== -->
            <div class="page-content" id="page-blueprint">
                <h3 style="margin-bottom: 15px; color: #333;">🎨 可视化蓝图编辑器</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                    通过拖放方式创建自动化策略。将左侧的触发器和动作节点拖到画布上，然后连接它们来创建策略流程。
                </p>
                
                <!-- 蓝图编辑器主容器 -->
                <div class="blueprint-editor">
                    <!-- 左侧节点面板 -->
                    <div class="node-palette">
                        <div class="palette-title">📦 节点工具箱</div>
                        
                        <!-- 触发器类型 -->
                        <div class="palette-category">
                            <div class="palette-category-title">🔔 触发器</div>
                            <div class="palette-item" draggable="true" data-node-type="trigger-time">
                                <span class="item-icon">⏰</span>
                                <span class="item-name">定时触发器</span>
                            </div>
                            <div class="palette-item" draggable="true" data-node-type="trigger-sensor">
                                <span class="item-icon">📡</span>
                                <span class="item-name">传感器触发</span>
                            </div>
                        </div>
                        
                        <!-- 动作类型 -->
                        <div class="palette-category">
                            <div class="palette-category-title">⚡ 动作</div>
                            <div class="palette-item" draggable="true" data-node-type="action-relay">
                                <span class="item-icon">🎛️</span>
                                <span class="item-name">继电器控制</span>
                            </div>
                            <div class="palette-item" draggable="true" data-node-type="action-group">
                                <span class="item-icon">📦</span>
                                <span class="item-name">分组控制</span>
                            </div>
                        </div>
                        
                        <!-- 显示类型 -->
                        <div class="palette-category">
                            <div class="palette-category-title">📊 展示</div>
                            <div class="palette-item" draggable="true" data-node-type="device">
                                <span class="item-icon">🔌</span>
                                <span class="item-name">设备节点</span>
                            </div>
                            <div class="palette-item" draggable="true" data-node-type="group">
                                <span class="item-icon">📂</span>
                                <span class="item-name">分组节点</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 中间画布区域 -->
                    <div class="blueprint-canvas-container">
                        <!-- 工具栏 -->
                        <div class="canvas-toolbar">
                            <button onclick="clearBlueprint()" title="删除所有节点和连线">🗑️ 清空画布</button>
                            <button class="success" onclick="deployBlueprintStrategies()" title="将蓝图转换为实际的RPC策略">🚀 部署策略</button>
                            <button class="warning" onclick="loadExistingStrategies()" title="从服务器读取已有的策略并显示在画布上">📋 读取策略</button>
                            <button class="secondary" onclick="generateSystemDiagram()" title="从服务器读取设备和分组信息">📊 生成系统框图</button>
                            <button onclick="downloadBlueprint()" title="将蓝图保存为JSON文件">💾 导出蓝图</button>
                            <button onclick="uploadBlueprint()" title="从JSON文件导入蓝图">📂 导入蓝图</button>
                        </div>
                        
                        <!-- 蓝图画布 -->
                        <div class="blueprint-canvas" id="blueprintCanvas">
                            <!-- 空状态提示 -->
                            <div class="canvas-empty-hint" id="canvasEmptyHint">
                                <div class="hint-icon">🎨</div>
                                <div class="hint-text">
                                    从左侧拖放节点到此处<br>
                                    创建您的自动化策略
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧属性面板 -->
                    <div class="node-properties-panel" id="nodePropertiesPanel">
                        <div class="properties-header">
                            <span class="prop-icon">⚙️</span>
                            <span class="prop-title">节点属性</span>
                        </div>
                        <div class="properties-content">
                            <p class="prop-description">选择一个节点查看和编辑其属性</p>
                        </div>
                    </div>
                </div>
                
                <!-- 简化使用说明 -->
                <details style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #666;">📖 使用说明（点击展开）</summary>
                    <ul style="margin-top: 10px; color: #666; font-size: 13px; line-height: 1.8;">
                        <li><strong>添加节点：</strong>从左侧工具箱拖放到画布</li>
                        <li><strong>连接：</strong>拖动输出端口（橙色）到输入端口（绿色）</li>
                        <li><strong>配置：</strong>点击节点在右侧面板编辑属性</li>
                        <li><strong>部署：</strong>点击"部署策略"将蓝图转换为实际策略</li>
                        <li><strong>读取：</strong>点击"读取策略"从服务器加载现有策略</li>
                    </ul>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                        <strong style="color: #333;">⌨️ 键盘快捷键：</strong>
                        <span style="margin-left: 10px;">Delete=删除 | Ctrl+D=复制 | Shift+拖拽=精确定位 | Esc=取消选择</span>
                    </div>
                </details>
            </div>

            </div><!-- 结束 .card -->
        </div><!-- 结束 .content-area -->

        <!-- ==================== 右侧通信日志面板 ==================== -->
        <div class="log-sidebar">
            <div class="card log-card">
                <h2>📝 通信日志</h2>
                <div style="margin-bottom: 15px;">
                    <button class="secondary" onclick="clearLog()">🗑️ 清空日志</button>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-placeholder">等待操作...</div>
                </div>
            </div>
        </div><!-- 结束 .log-sidebar -->
    </div><!-- 结束 .main-layout -->

    <!-- 引入外部JavaScript -->
    <script src="js/app.js"></script>
    <script src="js/blueprint.js"></script>
</body>
</html>
