<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>泛舟RPC服务器调试工具</title>
    <!-- ========================================================
         泛舟RPC服务器调试工具
         
         功能说明：
         1. 通过WebSocket连接到RPC服务器（需要websocket代理）
         2. 提供快捷操作按钮用于常用RPC方法
         3. 支持继电器控制和分组管理
         4. 提供设备列表和分组列表的可视化显示
         5. 左右布局：导航在左侧，内容在右侧
         6. 动态背景动画效果
         
         使用方法：
         1. 在设备上启动websocat代理：
            websocat --text ws-l:0.0.0.0:12346 tcp:127.0.0.1:12345
         2. 在浏览器中打开此页面
         3. 输入设备IP地址和WebSocket端口，点击连接
         
         RPC说明：
         - relay.control: 控制单个节点的单个通道
         - group.control: 控制分组中所有节点的指定通道
         ======================================================== -->
    <!-- 引入外部样式表 -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/blueprint.css">
</head>
<body>
    <!-- ==================== 动态背景动画 ==================== -->
    <div class="animated-background"></div>
    <div class="floating-shapes">
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>

    <!-- ==================== 页面头部 ==================== -->
    <div class="header">
        <h1>🚀 泛舟RPC服务器调试工具</h1>
        <p>用于调试运行在全志A133平台上的JSON-RPC服务器</p>
    </div>

    <!-- ==================== 连接设置卡片 ==================== -->
    <div class="card" style="max-width: 1600px; margin: 0 auto 20px;">
        <h2>📡 连接设置</h2>
        <div class="connection-panel">
            <!-- 服务器地址输入 -->
            <div class="form-group" style="flex: 2; min-width: 200px;">
                <label>服务器地址</label>
                <input type="text" id="serverHost" placeholder="例如: 192.168.1.100" value="localhost">
            </div>
            <!-- WebSocket端口输入 -->
            <div class="form-group" style="flex: 1; min-width: 120px;">
                <label>WebSocket端口</label>
                <input type="number" id="serverPort" placeholder="端口" value="12346">
            </div>
            <!-- 连接/断开按钮 -->
            <div class="form-group" style="min-width: 120px;">
                <label>&nbsp;</label>
                <button id="connectBtn" onclick="toggleConnection()">🔌 连接</button>
            </div>
            <!-- 连接状态显示 -->
            <div class="form-group" style="min-width: 100px;">
                <label>状态</label>
                <span class="status-badge disconnected" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span>未连接</span>
                </span>
            </div>
        </div>
        <!-- 连接说明 -->
        <div class="help-section">
            <h4>📋 连接说明</h4>
            <p style="margin-bottom: 10px; color: #666;">由于浏览器安全限制，需要在设备上运行WebSocket代理。请执行以下命令：</p>
            <pre>
# 安装websocat（如果尚未安装）
# 下载地址: https://github.com/vi/websocat/releases

# 启动WebSocket到TCP的代理（文本模式）
websocat --text ws-l:0.0.0.0:12346 tcp:127.0.0.1:12345</pre>
        </div>
    </div>

    <!-- ==================== 主布局容器 - 左右布局 ==================== -->
    <div class="main-layout">
        <!-- ==================== 左侧导航栏 ==================== -->
        <div class="sidebar">
            <div class="sidebar-nav">
                <button class="nav-btn active" onclick="showPage('quick')" data-page="quick">
                    ⚡ 快捷操作
                </button>
                <button class="nav-btn" onclick="showPage('devices')" data-page="devices">
                    🔌 设备列表
                </button>
                <button class="nav-btn" onclick="showPage('groups')" data-page="groups">
                    📂 分组管理
                </button>
                <button class="nav-btn" onclick="showPage('strategy')" data-page="strategy">
                    ⚙️ 策略管理
                </button>
                <button class="nav-btn" onclick="showPage('blueprint')" data-page="blueprint">
                    🎨 蓝图编辑器
                </button>
                <button class="nav-btn" onclick="showPage('relay')" data-page="relay">
                    🎛️ 继电器控制
                </button>
                <button class="nav-btn" onclick="showPage('custom')" data-page="custom">
                    🛠️ 自定义调用
                </button>
                <button class="nav-btn" onclick="showPage('help')" data-page="help">
                    📖 使用帮助
                </button>
            </div>
        </div>

        <!-- ==================== 右侧内容区 ==================== -->
        <div class="content-area">
            <div class="card">

            <!-- ==================== 快捷操作页面 ==================== -->
            <div class="page-content active" id="page-quick">
                <h3 style="margin-bottom: 20px; color: #333;">常用RPC方法快捷按钮</h3>
                <div class="quick-actions-grid">
                    <button class="quick-action-btn" onclick="callMethod('rpc.ping', {})">
                        <span class="icon">🔔</span>
                        Ping测试
                    </button>
                    <button class="quick-action-btn" onclick="callMethod('rpc.list', {})">
                        <span class="icon">📋</span>
                        列出方法
                    </button>
                    <button class="quick-action-btn" onclick="callMethod('sys.info', {})">
                        <span class="icon">ℹ️</span>
                        系统信息
                    </button>
                    <button class="quick-action-btn success" onclick="refreshDeviceList()">
                        <span class="icon">🔌</span>
                        刷新设备
                    </button>
                    <button class="quick-action-btn success" onclick="callMethod('relay.queryAll', {})">
                        <span class="icon">🔍</span>
                        查询全部
                    </button>
                    <button class="quick-action-btn success" onclick="refreshGroupList()">
                        <span class="icon">📂</span>
                        刷新分组
                    </button>
                    <button class="quick-action-btn warning" onclick="callMethod('control.queue.status', {})">
                        <span class="icon">📊</span>
                        队列状态
                    </button>
                    <button class="quick-action-btn" onclick="refreshStrategyList()">
                        <span class="icon">⚙️</span>
                        策略列表
                    </button>
                </div>
            </div>

            <!-- ==================== 设备列表页面 ==================== -->
            <div class="page-content" id="page-devices">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">设备列表</h3>
                    <div class="btn-group">
                        <button onclick="refreshDeviceList()">🔄 刷新列表</button>
                        <button class="secondary" onclick="readDeviceConfig()">📋 读取配置</button>
                    </div>
                </div>
                
                <!-- 设备配置显示区域 -->
                <div id="deviceConfigPanel" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">📋 设备配置信息</h4>
                    <pre id="deviceConfigContent" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 13px;"></pre>
                </div>
                
                <div class="data-list" id="deviceList">
                    <div class="data-list-header">
                        <span>设备节点</span>
                        <span>操作</span>
                    </div>
                    <div class="data-list-empty" id="deviceListEmpty">
                        <p>暂无设备数据</p>
                        <p style="font-size: 12px; margin-top: 10px;">请先连接服务器并点击"刷新列表"</p>
                    </div>
                    <div id="deviceListContent"></div>
                </div>
                <!-- 设备状态卡片视图 -->
                <div class="device-cards" id="deviceCards"></div>
            </div>

            <!-- ==================== 分组管理页面 ==================== -->
            <div class="page-content" id="page-groups">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">分组管理</h3>
                    <button onclick="refreshGroupList()">🔄 刷新列表</button>
                </div>
                
                <!-- 创建分组表单 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">➕ 创建新分组</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>分组ID</label>
                            <input type="number" id="newGroupId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>分组名称</label>
                            <input type="text" id="newGroupName" placeholder="例如: main-group">
                        </div>
                    </div>
                    <button class="success" onclick="createGroup()">➕ 创建分组</button>
                </div>

                <!-- 添加设备到分组 -->
                <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">🔗 添加设备到分组</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>分组ID</label>
                            <input type="number" id="addDeviceGroupId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>设备节点ID</label>
                            <input type="number" id="addDeviceNodeId" value="1" min="1" max="255">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="success" onclick="addDeviceToGroup()">➕ 添加设备</button>
                        <button class="danger" onclick="removeDeviceFromGroup()">➖ 移除设备</button>
                    </div>
                </div>

                <!-- 分组列表 -->
                <div class="data-list" id="groupList">
                    <div class="data-list-header">
                        <span>分组信息</span>
                        <span>操作</span>
                    </div>
                    <div class="data-list-empty" id="groupListEmpty">
                        <p>暂无分组数据</p>
                        <p style="font-size: 12px; margin-top: 10px;">请先连接服务器并点击"刷新列表"</p>
                    </div>
                    <div id="groupListContent"></div>
                </div>
            </div>

            <!-- ==================== 策略管理页面 ==================== -->
            <div class="page-content" id="page-strategy">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">策略管理</h3>
                    <button onclick="refreshStrategyList()">🔄 刷新列表</button>
                </div>

                <!-- 创建定时策略 -->
                <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">⏱️ 创建定时策略</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>策略ID</label>
                            <input type="number" id="newStrategyId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>策略名称</label>
                            <input type="text" id="newStrategyName" placeholder="例如: 定时通风">
                        </div>
                        <div class="form-group">
                            <label>绑定分组ID</label>
                            <input type="number" id="newStrategyGroupId" value="1" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>控制通道</label>
                            <select id="newStrategyChannel">
                                <option value="0">通道 0</option>
                                <option value="1">通道 1</option>
                                <option value="2">通道 2</option>
                                <option value="3">通道 3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>执行动作</label>
                            <select id="newStrategyAction">
                                <option value="stop">⏹️ 停止</option>
                                <option value="fwd">▶️ 正转</option>
                                <option value="rev">◀️ 反转</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>执行间隔（秒）</label>
                            <input type="number" id="newStrategyInterval" value="60" min="1">
                        </div>
                        <div class="form-group">
                            <label>自动启动</label>
                            <select id="newStrategyAutoStart">
                                <option value="true">是</option>
                                <option value="false">否</option>
                            </select>
                        </div>
                    </div>
                    <button class="success" onclick="createTimerStrategy()">➕ 创建定时策略</button>
                </div>
                
                <!-- 传感器触发策略 -->
                <div style="background: #fff3e0; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">📡 传感器触发策略</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                        当传感器数值满足阈值条件时，自动触发分组控制动作。策略可与分组程序联动。
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>策略ID</label>
                            <input type="number" id="sensorStrategyId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>策略名称</label>
                            <input type="text" id="sensorStrategyName" placeholder="例如: 高温报警">
                        </div>
                        <div class="form-group">
                            <label>传感器类型</label>
                            <select id="sensorType">
                                <option value="temperature">🌡️ 温度传感器</option>
                                <option value="humidity">💧 湿度传感器</option>
                                <option value="light">💡 光照传感器</option>
                                <option value="pressure">📊 压力传感器</option>
                                <option value="soil_moisture">🌱 土壤湿度传感器</option>
                                <option value="co2">🌫️ CO2传感器</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>传感器节点ID</label>
                            <input type="number" id="sensorNodeId" value="1" min="1" max="255">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>阈值条件</label>
                            <select id="sensorCondition">
                                <option value="gt">大于 (>)</option>
                                <option value="lt">小于 (<)</option>
                                <option value="eq">等于 (=)</option>
                                <option value="gte">大于等于 (>=)</option>
                                <option value="lte">小于等于 (<=)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>阈值</label>
                            <input type="number" id="sensorThreshold" value="25" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>绑定分组ID</label>
                            <input type="number" id="sensorGroupId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>控制通道</label>
                            <select id="sensorChannel">
                                <option value="0">通道 0</option>
                                <option value="1">通道 1</option>
                                <option value="2">通道 2</option>
                                <option value="3">通道 3</option>
                                <option value="-1">所有通道</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>触发动作</label>
                            <select id="sensorAction">
                                <option value="stop">⏹️ 停止</option>
                                <option value="fwd">▶️ 正转</option>
                                <option value="rev">◀️ 反转</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>冷却时间（秒）</label>
                            <input type="number" id="sensorCooldown" value="60" min="0" title="触发后等待时间，防止频繁触发">
                        </div>
                        <div class="form-group">
                            <label>启用状态</label>
                            <select id="sensorEnabled">
                                <option value="true">启用</option>
                                <option value="false">禁用</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="success" onclick="createSensorStrategy()">➕ 创建传感器策略</button>
                    </div>
                </div>

                <!-- 分组程序设置 -->
                <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">🔧 分组程序设置</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                        分组程序可绑定到特定通道，由传感器策略或定时策略自动触发控制。
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>分组ID</label>
                            <input type="number" id="programGroupId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>设备节点ID</label>
                            <input type="number" id="programNodeId" value="1" min="1" max="255">
                        </div>
                        <div class="form-group">
                            <label>控制通道</label>
                            <select id="programChannel">
                                <option value="0">通道 0</option>
                                <option value="1">通道 1</option>
                                <option value="2">通道 2</option>
                                <option value="3">通道 3</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="success" onclick="addChannelToGroup()">➕ 添加通道到分组</button>
                        <button class="danger" onclick="removeChannelFromGroup()">➖ 移除通道</button>
                        <button onclick="getGroupChannels()">🔍 查看分组通道</button>
                    </div>
                </div>

                <!-- 策略列表 -->
                <div class="data-list" id="strategyList">
                    <div class="data-list-header">
                        <span>策略信息</span>
                        <span>操作</span>
                    </div>
                    <div class="data-list-empty" id="strategyListEmpty">
                        <p>暂无策略数据</p>
                        <p style="font-size: 12px; margin-top: 10px;">请先连接服务器并点击"刷新列表"</p>
                    </div>
                    <div id="strategyListContent"></div>
                </div>

                <!-- 传感器策略列表 -->
                <div class="data-list" id="sensorStrategyList" style="margin-top: 20px;">
                    <div class="data-list-header">
                        <span>传感器策略</span>
                        <span>操作</span>
                    </div>
                    <div class="data-list-empty" id="sensorStrategyListEmpty">
                        <p>暂无传感器策略</p>
                    </div>
                    <div id="sensorStrategyListContent"></div>
                </div>
            </div>

            <!-- ==================== 继电器控制页面 ==================== -->
            <div class="page-content" id="page-relay">
                <h3 style="margin-bottom: 20px; color: #333;">继电器控制面板</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>节点ID</label>
                        <input type="number" id="relayNode" value="1" min="1" max="255">
                    </div>
                    <div class="form-group">
                        <label>通道</label>
                        <select id="relayChannel">
                            <option value="0">通道 0</option>
                            <option value="1">通道 1</option>
                            <option value="2">通道 2</option>
                            <option value="3">通道 3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>动作</label>
                        <select id="relayAction">
                            <option value="stop">⏹️ 停止 (Stop)</option>
                            <option value="fwd">▶️ 正转 (Forward)</option>
                            <option value="rev">◀️ 反转 (Reverse)</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="success" onclick="controlRelay()">⚡ 执行控制</button>
                    <button onclick="queryRelay()">🔍 查询状态</button>
                    <button onclick="queryRelayAll()">📊 查询全部通道</button>
                </div>

                <!-- 分组控制 -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                    <h4 style="margin-bottom: 15px; color: #333;">📦 分组控制</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>分组ID</label>
                            <input type="number" id="groupControlId" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>通道</label>
                            <select id="groupControlChannel">
                                <option value="0">通道 0</option>
                                <option value="1">通道 1</option>
                                <option value="2">通道 2</option>
                                <option value="3">通道 3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>动作</label>
                            <select id="groupControlAction">
                                <option value="stop">⏹️ 停止 (Stop)</option>
                                <option value="fwd">▶️ 正转 (Forward)</option>
                                <option value="rev">◀️ 反转 (Reverse)</option>
                            </select>
                        </div>
                    </div>
                    <button class="success" onclick="controlGroup()">⚡ 执行分组控制</button>
                </div>
            </div>

            <!-- ==================== 自定义调用页面 ==================== -->
            <div class="page-content" id="page-custom">
                <h3 style="margin-bottom: 20px; color: #333;">自定义RPC调用</h3>
                <div class="form-group">
                    <label>方法名</label>
                    <input type="text" id="methodName" placeholder="例如: rpc.ping, relay.control">
                </div>
                <div class="form-group">
                    <label>参数 (JSON格式)</label>
                    <textarea id="methodParams" placeholder='例如: {"node": 1, "ch": 0, "action": "fwd"}'>{}</textarea>
                </div>
                <button onclick="callCustomMethod()">🚀 发送请求</button>
                
                <!-- 方法参考 -->
                <div class="help-section" style="margin-top: 20px;">
                    <h4>📚 常用方法参考</h4>
                    <ul>
                        <li><code>rpc.ping</code> - 测试连接 (无参数)</li>
                        <li><code>rpc.list</code> - 列出所有方法 (无参数)</li>
                        <li><code>sys.info</code> - 获取系统信息 (无参数)</li>
                        <li><code>relay.control</code> - 控制继电器 <code>{"node": 1, "ch": 0, "action": "fwd"}</code></li>
                        <li><code>relay.status</code> - 查询状态 <code>{"node": 1, "ch": 0}</code></li>
                        <li><code>relay.statusAll</code> - 查询单设备全部通道 <code>{"node": 1}</code></li>
                        <li><code>relay.nodes</code> - 设备列表（含在线状态）(无参数)</li>
                        <li><code>relay.queryAll</code> - 批量查询所有设备 (无参数)</li>
                        <li><code>group.list</code> - 分组列表 (无参数)</li>
                        <li><code>group.get</code> - 分组详情 <code>{"groupId": 1}</code></li>
                        <li><code>group.create</code> - 创建分组 <code>{"groupId": 1, "name": "分组名"}</code></li>
                        <li><code>group.delete</code> - 删除分组 <code>{"groupId": 1}</code></li>
                        <li><code>group.addDevice</code> - 添加设备到分组 <code>{"groupId": 1, "node": 1}</code></li>
                        <li><code>group.removeDevice</code> - 从分组移除设备 <code>{"groupId": 1, "node": 1}</code></li>
                        <li><code>group.addChannel</code> - 添加通道到分组 <code>{"groupId": 1, "node": 1, "channel": 0}</code></li>
                        <li><code>group.removeChannel</code> - 从分组移除通道 <code>{"groupId": 1, "node": 1, "channel": 0}</code></li>
                        <li><code>group.getChannels</code> - 获取分组通道列表 <code>{"groupId": 1}</code></li>
                        <li><code>group.control</code> - 分组控制 <code>{"groupId": 1, "ch": 0, "action": "stop"}</code></li>
                        <li><code>control.queue.status</code> - 控制队列状态 (无参数)</li>
                        <li><code>auto.strategy.list</code> - 自动策略列表 (无参数)</li>
                        <li><code>auto.strategy.create</code> - 创建策略 <code>{"id": 1, "name": "定时策略", "groupId": 1, "channel": 0, "action": "fwd", "intervalSec": 60}</code></li>
                        <li><code>auto.strategy.delete</code> - 删除策略 <code>{"id": 1}</code></li>
                        <li><code>auto.strategy.enable</code> - 启用/禁用策略 <code>{"id": 1, "enabled": true}</code></li>
                        <li><code>auto.strategy.trigger</code> - 手动触发策略 <code>{"id": 1}</code></li>
                        <li><code>auto.sensor.list</code> - 传感器策略列表 (无参数)</li>
                        <li><code>auto.sensor.create</code> - 创建传感器策略 <code>{"id": 1, "name": "高温报警", "sensorType": "temperature", "sensorNode": 1, "condition": "gt", "threshold": 30, "groupId": 1, "channel": 0, "action": "fwd"}</code></li>
                        <li><code>auto.sensor.delete</code> - 删除传感器策略 <code>{"id": 1}</code></li>
                    </ul>
                </div>
            </div>

            <!-- ==================== 蓝图编辑器页面 ==================== -->
            <div class="page-content" id="page-blueprint">
                <h3 style="margin-bottom: 15px; color: #333;">🎨 可视化蓝图编辑器</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                    通过拖放方式创建自动化策略。将左侧的触发器和动作节点拖到画布上，然后连接它们来创建策略流程。
                </p>
                
                <!-- 蓝图编辑器主容器 -->
                <div class="blueprint-editor">
                    <!-- 左侧节点面板 -->
                    <div class="node-palette">
                        <div class="palette-title">📦 节点工具箱</div>
                        
                        <!-- 触发器类型 -->
                        <div class="palette-category">
                            <div class="palette-category-title">🔔 触发器</div>
                            <div class="palette-item" draggable="true" data-node-type="trigger-time">
                                <span class="item-icon">⏰</span>
                                <span class="item-name">定时触发器</span>
                            </div>
                            <div class="palette-item" draggable="true" data-node-type="trigger-sensor">
                                <span class="item-icon">📡</span>
                                <span class="item-name">传感器触发</span>
                            </div>
                        </div>
                        
                        <!-- 动作类型 -->
                        <div class="palette-category">
                            <div class="palette-category-title">⚡ 动作</div>
                            <div class="palette-item" draggable="true" data-node-type="action-relay">
                                <span class="item-icon">🎛️</span>
                                <span class="item-name">继电器控制</span>
                            </div>
                            <div class="palette-item" draggable="true" data-node-type="action-group">
                                <span class="item-icon">📦</span>
                                <span class="item-name">分组控制</span>
                            </div>
                        </div>
                        
                        <!-- 显示类型 -->
                        <div class="palette-category">
                            <div class="palette-category-title">📊 展示</div>
                            <div class="palette-item" draggable="true" data-node-type="device">
                                <span class="item-icon">🔌</span>
                                <span class="item-name">设备节点</span>
                            </div>
                            <div class="palette-item" draggable="true" data-node-type="group">
                                <span class="item-icon">📂</span>
                                <span class="item-name">分组节点</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 中间画布区域 -->
                    <div class="blueprint-canvas-container">
                        <!-- 工具栏 -->
                        <div class="canvas-toolbar">
                            <button onclick="clearBlueprint()">🗑️ 清空</button>
                            <button class="success" onclick="deployBlueprintStrategies()">🚀 部署策略</button>
                            <button class="secondary" onclick="generateSystemDiagram()">📊 生成系统框图</button>
                            <button onclick="downloadBlueprint()">💾 导出</button>
                            <button onclick="uploadBlueprint()">📂 导入</button>
                        </div>
                        
                        <!-- 蓝图画布 -->
                        <div class="blueprint-canvas" id="blueprintCanvas">
                            <!-- 空状态提示 -->
                            <div class="canvas-empty-hint" id="canvasEmptyHint">
                                <div class="hint-icon">🎨</div>
                                <div class="hint-text">
                                    从左侧拖放节点到此处<br>
                                    创建您的自动化策略
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧属性面板 -->
                    <div class="node-properties-panel" id="nodePropertiesPanel">
                        <div class="properties-header">
                            <span class="prop-icon">⚙️</span>
                            <span class="prop-title">节点属性</span>
                        </div>
                        <div class="properties-content">
                            <p class="prop-description">选择一个节点查看和编辑其属性</p>
                        </div>
                    </div>
                </div>
                
                <!-- 使用说明 -->
                <div class="help-section" style="margin-top: 20px;">
                    <h4>📖 蓝图编辑器使用说明</h4>
                    <ul>
                        <li><strong>添加节点：</strong>从左侧工具箱拖放节点到画布上</li>
                        <li><strong>连接节点：</strong>从触发器的输出端口（右侧橙色圆点）拖到动作的输入端口（左侧绿色圆点）</li>
                        <li><strong>配置节点：</strong>点击节点查看右侧属性面板，双击快速编辑</li>
                        <li><strong>删除节点：</strong>点击节点右上角的×按钮，或点击连线后确认删除</li>
                        <li><strong>部署策略：</strong>完成连线后点击"部署策略"将蓝图转换为实际的RPC策略</li>
                        <li><strong>系统框图：</strong>点击"生成系统框图"可自动从服务器读取设备和分组信息</li>
                    </ul>
                </div>
            </div>

            <!-- ==================== 使用帮助页面 ==================== -->
            <div class="page-content" id="page-help">
                <h3 style="margin-bottom: 20px; color: #333;">使用帮助</h3>
                
                <div class="help-section">
                    <h4>1. 命令行调试方式</h4>
                    <pre>
# 使用 netcat 发送 JSON-RPC 请求
echo '{"jsonrpc":"2.0","id":1,"method":"rpc.ping","params":{}}' | nc localhost 12345

# 使用 socat 测试
echo '{"jsonrpc":"2.0","id":1,"method":"relay.nodes","params":{}}' | socat - TCP:localhost:12345</pre>
                </div>

                <div class="help-section">
                    <h4>2. A133平台部署信息</h4>
                    <ul>
                        <li>确保CAN接口已正确配置 (can0)</li>
                        <li>RPC服务默认监听端口: <code>12345</code></li>
                        <li>WebSocket代理建议端口: <code>12346</code></li>
                        <li>配置文件位于: <code>/var/lib/fanzhou_core/core.json</code></li>
                        <li>日志文件位于: <code>/var/log/fanzhou_core/core.log</code></li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>3. 错误码说明</h4>
                    <ul>
                        <li><code>-32700</code> - JSON解析错误</li>
                        <li><code>-32600</code> - 无效请求</li>
                        <li><code>-32601</code> - 方法不存在</li>
                        <li><code>-32602</code> - 无效参数</li>
                        <li><code>-60010</code> - 缺少必需参数</li>
                        <li><code>-60011</code> - 参数类型错误</li>
                        <li><code>-60120</code> - CAN未打开</li>
                        <li><code>-60122</code> - CAN写入失败</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>4. WebSocket代理配置</h4>
                    <pre>
# 方法一: 使用 websocat（文本模式）
websocat --text ws-l:0.0.0.0:12346 tcp:127.0.0.1:12345

# 方法二: 使用 websocketd (需要脚本)
websocketd --port=12346 socat - TCP:127.0.0.1:12345

# 开机自启动 (systemd服务)
# /etc/systemd/system/ws-proxy.service
[Unit]
Description=WebSocket to TCP Proxy
After=network.target

[Service]
ExecStart=/usr/bin/websocat --text ws-l:0.0.0.0:12346 tcp:127.0.0.1:12345
Restart=always

[Install]
WantedBy=multi-user.target</pre>
                </div>
            </div><!-- 结束 page-help -->

            </div><!-- 结束 .card -->
        </div><!-- 结束 .content-area -->

        <!-- ==================== 右侧通信日志面板 ==================== -->
        <div class="log-sidebar">
            <div class="card log-card">
                <h2>📝 通信日志</h2>
                <div style="margin-bottom: 15px;">
                    <button class="secondary" onclick="clearLog()">🗑️ 清空日志</button>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-placeholder">等待操作...</div>
                </div>
            </div>
        </div><!-- 结束 .log-sidebar -->
    </div><!-- 结束 .main-layout -->

    <!-- 引入外部JavaScript -->
    <script src="js/app.js"></script>
    <script src="js/blueprint.js"></script>
</body>
</html>
