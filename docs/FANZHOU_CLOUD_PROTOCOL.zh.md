# 泛舟云平台大棚智能控制柜系统技术文档

## 一、系统总体架构

每个大棚内部 1 台控制柜，柜内以"控制屏"为核心。

控制屏通过 RS485/LoRa/CAN 对接：
- 室内温湿度、光照、CO₂ 传感器等
- 土壤温度/湿度 传感器等
- 继电器输出模块（控制风机、遮阳、喷淋等）

园区1台/多台室外气象站（风速、光照、大气温湿度、气压等），气象站可绑定为哪些控制柜提供数据，如未绑定则推送到全部控制柜。

### 通信架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                           云端平台                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐  │
│  │  数据存储   │  │  规则计算   │  │      可视化/告警             │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────────────┘
                            │ MQTT
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       控制柜（控制屏）                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐  │
│  │ 场景管理器  │  │ 消息处理器  │  │     本地存储                 │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────────────┘
                            │ RS485/LoRa/CAN
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐  │
│  │   传感器    │  │  继电器模块  │  │     气象站                   │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

- 控制屏与云端双向 MQTT 通信
- 云端负责：数据存储、规则计算、场景配置、可视化、告警
- 云端将气象站上报数据通过MQTT下发同步给园区中的所关联/所有控制柜
- 本地离线时，控制屏可按最后一次同步的场景继续运行

## 二、通信协议（MQTT）

按AIOT平台要求配置，使用标准MQTT 3.1.1协议。

## 三、数据报文格式

保持原AIOT平台上报数据格式，`setting`字段为特殊字段，用于同步设备配置。

### 3.1 基础报文格式

```json
{
    "airTemp": 26.3,          // 空气温度
    "airHum": 58.2,           // 空气湿度
    "light": 42000,           // 光照
    "co2": 820,               // 二氧化碳
    "soilTemp": 19.4,         // 土壤温度
    "soilHum": 33,            // 土壤湿度
    "soilEC": 1.2,            // mS/cm
    "sw1": 1,                 // 继电器1状态
    "sw2": 0,                 // 继电器2状态
    "setting": "json字符串"    // 配置字段（JSON字符串）
}
```

### 3.2 setting字段格式

`setting`值需转为JSON字符串，内部结构如下：

```json
{
    "method": "get" | "set" | "delete" | "get_response" | "set_response" | "delete_response" | "delete_sync" | "delete_ack",
    "data": { ... },
    "requestId": "req_202307011430001",
    "responseId": "resp_202307011430001",
    "timestamp": 1625123456789,
    "error": { "code": 2001, "message": "错误描述" }
}
```

## 四、场景同步协议

### 4.1 场景数据结构

```json
{
    "id": 100,                            // 场景ID，新增时由云端分配
    "sceneName": "智能补光",               // 场景名称
    "sceneType": "auto|manual",           // auto自动场景，manual手动场景
    "matchType": 0,                       // 触发方式：0-全部条件，1-任一条件
    "effectiveBeginTime": "06:00",        // 生效开始时间
    "effectiveEndTime": "18:00",          // 生效结束时间
    "status": 0,                          // 场景状态：0-正常，1-关闭
    "version": 1,                         // 场景版本号
    "createTime": "2026-01-15 10:30:00",  // 创建时间
    "updateTime": "2026-01-15 10:30:00",  // 更新时间
    "actions": [{
        "deviceCode": "864708069172099",  // 设备编码
        "identifier": "sw2",              // 属性标识
        "identifierValue": 1              // 属性值
    }],
    "conditions": [{
        "deviceCode": "864708069172099",  // 设备编码
        "identifier": "airTemp",          // 属性标识
        "identifierValue": 30,            // 属性值
        "op": "egt"                       // 条件操作符
    }]
}
```

### 4.2 条件操作符

| 操作符 | 说明 |
|--------|------|
| `eq`   | 等于 |
| `ne`   | 不等于 |
| `gt`   | 大于 |
| `lt`   | 小于 |
| `egt`  | 大于等于 |
| `elt` / `le` | 小于等于 |

### 4.3 场景查询

#### 4.3.1 柜端上行查询

```json
{
    "setting": {
        "method": "get",
        "data": {"scene": 1},             // 1为场景ID，传0为获取所有场景
        "requestId": "req_202307011430001",
        "timestamp": 1625123456789
    }
}
```

#### 4.3.2 云端下行响应

```json
{
    "setting": {
        "method": "get_response",
        "data": {
            "scene": [
                {
                    "id": 100,
                    "sceneName": "智能补光",
                    "sceneType": "auto",
                    // ... 完整场景数据
                }
            ]
        },
        "requestId": "req_202307011430001",
        "timestamp": 1625123457890
    }
}
```

#### 4.3.3 错误响应

```json
{
    "setting": {
        "method": "get_response",
        "data": {"scene": []},
        "error": {
            "code": 2001,
            "message": "场景不存在"
        },
        "requestId": "req_202307011430001",
        "timestamp": 1625123457890
    }
}
```

### 4.4 场景新增/编辑

#### 4.4.1 柜端上行请求

```json
{
    "setting": {
        "method": "set",
        "data": {
            "scene": [{
                "id": 100,                // 有ID为编辑，无ID为新增
                "sceneName": "智能补光",
                "sceneType": "auto",
                // ... 完整场景数据
            }]
        },
        "requestId": "req_202307011430001",
        "timestamp": 1625123456789
    }
}
```

#### 4.4.2 云端下行响应

```json
{
    "setting": {
        "method": "set_response",
        "data": {
            "scene": [{
                "id": 105,                // 云端分配的场景ID
                "sceneName": "智能补光",
                "status": "success",      // 处理状态
                "version": 1,             // 云端确认版本
                "createTime": "2023-07-01 14:35:00"
            }]
        },
        "requestId": "req_202307011430001",
        "responseId": "resp_202307011435001",
        "timestamp": 1625123458901
    }
}
```

### 4.5 场景删除

#### 4.5.1 柜端请求删除

```json
{
    "setting": {
        "method": "delete",
        "data": {
            "scene": [102]                // 要删除的场景ID数组
        },
        "requestId": "del_202307021030001",
        "timestamp": 1625123456789
    }
}
```

#### 4.5.2 云端返回响应

```json
{
    "setting": {
        "method": "delete_response",
        "data": {
            "scene": [{
                "id": 102,
                "sceneName": "旧版通风策略",
                "status": "deleted",
                "deleteTime": "2023-07-02 10:32:00"
            }]
        },
        "requestId": "del_202307021030001",
        "responseId": "resp_202307021032001",
        "timestamp": 1625123458901
    }
}
```

### 4.6 云端主动同步

#### 4.6.1 云端下发场景

```json
{
    "setting": {
        "method": "set",
        "data": {
            "scene": [
                {
                    "id": 101,
                    "sceneName": "高温通风",
                    "sceneType": "auto",
                    // ... 完整场景数据
                }
            ]
        },
        "requestId": "req_202307021030001",
        "timestamp": 1625123456789
    }
}
```

#### 4.6.2 柜端返回确认

```json
{
    "setting": {
        "method": "set_response",
        "data": {
            "scene": [{
                "id": 101,
                "status": "success",
                "version": 2,
                "errorCode": 0,
                "errorMsg": ""
            }]
        },
        "requestId": "req_202307021030001",
        "timestamp": 1625123457890
    }
}
```

### 4.7 云端主动删除同步

#### 4.7.1 云端下发删除指令

```json
{
    "setting": {
        "method": "delete_sync",
        "data": {
            "scene": [106, 107],
            "deleteReason": "管理员批量清理"
        },
        "requestId": "req_202307021100001",
        "timestamp": 1625123459234
    }
}
```

#### 4.7.2 柜端确认删除

```json
{
    "setting": {
        "method": "delete_ack",
        "data": {
            "scene": [
                {
                    "id": 106,
                    "sceneName": "旧场景A",
                    "status": "deleted",
                    "deleteTime": "2023-07-02 11:01:00"
                },
                {
                    "id": 107,
                    "sceneName": "旧场景B",
                    "status": "not_found",
                    "errorCode": 0,
                    "errorMsg": "场景不存在于本地"
                }
            ]
        },
        "requestId": "req_202307021100001",
        "timestamp": 1625123459345
    }
}
```

## 五、错误码定义

### 5.1 查询错误码

| 错误码 | 错误描述 | 处理建议 |
|--------|----------|----------|
| 2001 | 场景不存在 | 检查场景ID是否正确 |
| 2002 | 权限不足 | 检查设备绑定关系 |
| 2003 | 查询参数错误 | 检查查询参数格式 |

### 5.2 设置错误码

| 错误码 | 错误描述 | 处理建议 |
|--------|----------|----------|
| 3001 | 场景格式错误 | 检查JSON格式 |
| 3002 | 场景名称已存在 | 修改场景名称 |
| 3003 | 条件配置冲突 | 调整条件逻辑 |
| 3004 | 动作配置错误 | 检查动作参数 |
| 3005 | 权限不足 | 检查设备权限 |
| 3006 | 场景数量超限 | 删除无用场景 |
| 3007 | 时间范围无效 | 检查时间配置 |

### 5.3 柜端处理错误码

| 错误码 | 错误描述 | 处理建议 |
|--------|----------|----------|
| 0 | 成功 | - |
| 1001 | 场景格式错误 | 检查JSON格式 |
| 1002 | 条件配置错误 | 检查条件逻辑 |
| 1003 | 动作配置错误 | 检查动作设备编码 |
| 1004 | 存储空间不足 | 清理本地存储 |
| 1005 | 版本冲突 | 需要人工干预 |
| 1006 | 设备编码不存在 | 检查设备绑定 |
| 1007 | 时间格式错误 | 检查时间格式 |
| 1008 | 超出场景数量限制 | 删除不必要场景 |

### 5.4 删除错误码

| 错误码 | 错误描述 | 处理建议 |
|--------|----------|----------|
| 4001 | 场景不存在 | 检查场景ID是否正确 |
| 4002 | 权限不足 | 检查用户权限 |

## 六、RPC接口

### 6.1 场景管理接口

| 方法 | 参数 | 说明 |
|------|------|------|
| `scene.list` | `{id?}` | 获取场景列表，id为0或省略获取全部 |
| `scene.get` | `{id}` | 获取单个场景详情 |
| `scene.save` | `{场景对象}` | 创建或更新场景 |
| `scene.delete` | `{id}` | 删除场景 |
| `scene.enable` | `{id, enabled}` | 启用/禁用场景 |
| `scene.trigger` | `{id}` | 手动触发场景 |
| `scene.syncFromCloud` | `{id?}` | 从云端拉取场景 |
| `scene.updateDeviceValue` | `{deviceCode, identifier, value}` | 更新设备属性值用于条件评估 |

### 6.2 使用示例

#### 获取所有场景

```bash
echo '{"jsonrpc":"2.0","id":1,"method":"scene.list","params":{}}' | nc localhost 12345
```

#### 创建新场景

```bash
echo '{"jsonrpc":"2.0","id":1,"method":"scene.save","params":{
    "sceneName":"高温通风",
    "sceneType":"auto",
    "matchType":0,
    "effectiveBeginTime":"06:00",
    "effectiveEndTime":"18:00",
    "status":0,
    "actions":[{"deviceCode":"1","identifier":"sw1","identifierValue":1}],
    "conditions":[{"deviceCode":"1","identifier":"airTemp","identifierValue":30,"op":"egt"}]
}}' | nc localhost 12345
```

#### 手动触发场景

```bash
echo '{"jsonrpc":"2.0","id":1,"method":"scene.trigger","params":{"id":100}}' | nc localhost 12345
```

## 七、本地存储

场景数据存储在本地文件 `/var/lib/fanzhou_core/scenes.json`，格式如下：

```json
{
    "nextSceneId": 101,
    "scenes": [
        {
            "id": 100,
            "sceneName": "智能补光",
            // ... 完整场景数据
        }
    ]
}
```

### 离线处理

当网络断开时，控制柜将：
1. 继续执行本地存储的场景
2. 记录场景变更操作
3. 网络恢复后自动同步

## 八、版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0.0 | 2026-01-17 | 初始版本，实现场景同步协议 |
